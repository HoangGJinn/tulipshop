<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title=${isEditMode ? 'Cập nhật sản phẩm' : 'Thêm sản phẩm mới'})}">
    <style>
        .border-dashed { border-style: dashed !important; border-width: 2px !important; }
        .image-upload-box:hover { border-color: #0d6efd !important; background-color: #e9ecef !important; }
        #tag-input-field { min-width: 80px; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid bg-light py-4">
    <div class="container">
        <form th:action="@{/admin/products/save}" method="post" enctype="multipart/form-data" th:object="${productDTO}" id="productForm">

            <input type="hidden" th:field="*{id}">
            <input type="hidden" th:field="*{thumbnailUrl}">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-uppercase">
                    <span th:text="${isEditMode} ? 'Cập nhật sản phẩm' : 'Thêm sản phẩm mới'"></span>
                </h3>
                <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold shadow-sm">
                    <span th:text="${isEditMode} ? 'LƯU THAY ĐỔI' : 'ĐĂNG SẢN PHẨM'"></span>
                </button>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Thông tin chung</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tên sản phẩm <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" th:field="*{name}" placeholder="Ví dụ: Áo thun nam Cotton..." required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Mô tả sản phẩm</label>
                                <textarea class="form-control" th:field="*{description}" rows="6"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Dữ liệu sản phẩm</div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="productTab" role="tablist">
                                <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#general" type="button">Chung</button></li>
                                <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#variations" type="button">Các biến thể</button></li>
                            </ul>

                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="general">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Giá bán thường (VNĐ)</label>
                                            <input type="number" class="form-control" th:field="*{price}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Giá khuyến mãi (VNĐ)</label>
                                            <input type="number" class="form-control" th:field="*{discountPrice}">
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="variations">
                                    <div id="variants-container">
                                        <div th:each="variant, stat : *{variants}" class="variant-item border rounded p-3 mb-3 bg-white position-relative">
                                            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" onclick="removeVariantRow(this)"></button>

                                            <input type="hidden"
                                                   th:name="|variants[${stat.index}].id|"
                                                   th:value="${variant.id}">

                                            <div class="row g-3">
                                                <div class="col-md-4 border-end">
                                                    <h6 class="fw-bold mb-2 small text-uppercase">Màu sắc & Ảnh</h6>
                                                    <div class="mb-2">
                                                        <input type="text" class="form-control form-control-sm mb-1 variant-name"
                                                               placeholder="Tên màu" required
                                                               th:name="|variants[${stat.index}].colorName|"
                                                               th:value="${variant.colorName}">
                                                    </div>
                                                    <div class="mb-2 d-flex align-items-center gap-2">
                                                        <input type="color" class="form-control form-control-color variant-color-code"
                                                               th:name="|variants[${stat.index}].colorCode|"
                                                               th:value="${variant.colorCode}">
                                                        <small class="text-muted">Mã màu</small>
                                                    </div>
                                                    <div class="mt-2">
                                                        <label class="btn btn-light btn-sm w-100 border text-start text-truncate">
                                                            <i class="fas fa-images"></i> Thêm ảnh...
                                                            <input type="file" class="d-none variant-file" accept="image/*" multiple
                                                                   onchange="updateFileName(this)"
                                                                   th:name="|variants[${stat.index}].imageFiles|">
                                                        </label>
                                                        <div class="d-flex gap-1 mt-2 flex-wrap">
                                                            <img th:each="url : ${variant.imageUrls}" th:src="${url}"
                                                                 class="border rounded" style="width:40px;height:40px;object-fit:cover;">
                                                        </div>
                                                        <div class="variant-preview-list d-flex gap-1 mt-2 flex-wrap"></div>
                                                    </div>
                                                </div>

                                                <div class="col-md-8">
                                                    <h6 class="fw-bold mb-2 small text-uppercase">Kho hàng (Stock)</h6>
                                                    <div class="row g-2">
                                                        <div class="col-4 col-sm-3" th:each="size : ${allSizes}">
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text bg-light fw-bold" th:text="${size.code}"></span>
                                                                <input type="number" class="form-control text-center variant-stock"
                                                                       placeholder="0" min="0"
                                                                       th:name="|variants[${stat.index}].stockPerSize['${size.code}']|"
                                                                       th:value="${variant.stockPerSize != null ? (variant.stockPerSize.get(size.code) ?: 0) : 0}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-grid mt-3">
                                        <button type="button" class="btn btn-outline-primary border-dashed" onclick="addVariantRow()">
                                            <i class="fas fa-plus-circle"></i> Thêm biến thể
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Danh mục sản phẩm</div>
                        <div class="card-body">
                            <select class="form-select mb-2" id="categorySelect" th:field="*{categorySlug}">
                                <option value="" disabled selected>-- Chọn danh mục --</option>
                                <option th:each="cat : ${categories}"
                                        th:value="${cat.slug}"
                                        th:text="${cat.displayName}"
                                        th:data-id="${cat.id}"></option>
                            </select>
                            <a href="javascript:void(0)" class="text-decoration-none small fw-bold text-primary" onclick="toggleAddCategory()">
                                + Thêm danh mục mới
                            </a>
                            <div id="addCategoryPanel" class="mt-3 p-3 bg-light rounded border" style="display: none;">
                                <div class="mb-2">
                                    <input type="text" id="newCatName" class="form-control form-control-sm" placeholder="Tên danh mục mới">
                                </div>
                                <div class="mb-2">
                                    <select id="newCatParent" class="form-select form-select-sm">
                                        <option value="-1">-- Danh mục cha (Gốc) --</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary btn-sm w-100" onclick="addNewCategoryAjax()">Thêm danh mục</button>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Ảnh đại diện</div>
                        <div class="card-body text-center">
                            <div class="image-upload-box border rounded bg-light mb-3 d-flex align-items-center justify-content-center position-relative"
                                 style="height: 250px; cursor: pointer; overflow: hidden;"
                                 onclick="document.getElementById('mainImageInput').click()">

                                <img id="mainImagePreview" src="#" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <img id="currentImage" th:if="${productDTO.thumbnailUrl != null}"
                                     th:src="${productDTO.thumbnailUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                                <div id="mainImagePlaceholder" class="text-muted"
                                     th:style="${productDTO.thumbnailUrl != null ? 'display: none;' : 'display: block;'}">
                                    <i class="fas fa-image fa-2x mb-2"></i><br>Chọn ảnh
                                </div>
                            </div>
                            <input type="file" id="mainImageInput" class="d-none" th:field="*{mainImageFile}" accept="image/*" onchange="previewMainImage(this)">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tags</label>
                        <div id="tag-input-container" class="form-control d-flex flex-wrap align-items-center gap-2" style="min-height: 45px;">
                            <input type="text" id="tag-input-field" class="border-0 bg-transparent shadow-none" style="outline: none; min-width: 80px; flex-grow: 1;" placeholder="Nhập tag...">
                            <button type="button" id="btn-add-tag" class="btn btn-primary btn-sm rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 30px; height: 30px; padding: 0;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <input type="hidden" th:field="*{tags}" id="hidden-tags-input">
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<template id="variant-template">
    <div class="variant-item border rounded p-3 mb-3 bg-white position-relative">
        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" onclick="removeVariantRow(this)"></button>
        <div class="row g-3">
            <div class="col-md-4 border-end">
                <h6 class="fw-bold mb-2 small text-uppercase">Màu sắc & Ảnh</h6>
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm mb-1 variant-name" placeholder="Tên màu" required>
                </div>
                <div class="mb-2 d-flex align-items-center gap-2">
                    <input type="color" class="form-control form-control-color variant-color-code" value="#000000">
                    <small class="text-muted">Mã màu</small>
                </div>
                <div class="mt-2">
                    <label class="btn btn-light btn-sm w-100 border text-start text-truncate">
                        <i class="fas fa-images"></i> Thêm ảnh...
                        <input type="file" class="d-none variant-file" accept="image/*" multiple onchange="updateFileName(this)">
                    </label>
                    <div class="variant-preview-list d-flex gap-1 mt-2 flex-wrap"></div>
                </div>
            </div>
            <div class="col-md-8">
                <h6 class="fw-bold mb-2 small text-uppercase">Kho hàng</h6>
                <div class="row g-2">
                    <div class="col-4 col-sm-3" th:each="size : ${allSizes}">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light fw-bold" th:text="${size.code}"></span>
                            <input type="number" class="form-control text-center variant-stock" placeholder="0" min="0" th:data-size-code="${size.code}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script th:inline="javascript">
    // Biến toàn cục
    let variantIndex = [[${productDTO.variants != null ? productDTO.variants.size() : 0}]];
    let tags = [];

    // --- 1. Xử lý Ảnh chính ---
    function previewMainImage(input) {
        const preview = document.getElementById('mainImagePreview');
        const current = document.getElementById('currentImage');
        const placeholder = document.getElementById('mainImagePlaceholder');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                if(current) current.style.display = 'none';
                if(placeholder) placeholder.style.display = 'none';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 2. Xử lý Biến thể ---
    function addVariantRow() {
        const container = document.getElementById('variants-container');
        const template = document.getElementById('variant-template');
        if (!template) return;

        const clone = template.content.cloneNode(true);
        const div = clone.querySelector('.variant-item');

        // Gán name chuẩn Spring (Sử dụng string template literal của JS)
        div.querySelector('.variant-name').name = `variants[${variantIndex}].colorName`;
        div.querySelector('.variant-color-code').name = `variants[${variantIndex}].colorCode`;
        div.querySelector('.variant-file').name = `variants[${variantIndex}].imageFiles`;

        div.querySelectorAll('.variant-stock').forEach(input => {
            const sizeCode = input.getAttribute('data-size-code');
            input.name = `variants[${variantIndex}].stockPerSize['${sizeCode}']`;
            input.value = 0;
        });

        container.appendChild(div);
        variantIndex++;
    }

    function removeVariantRow(btn) {
        btn.closest('.variant-item').remove();
    }

    function updateFileName(input) {
        const previewContainer = input.parentElement.nextElementSibling;
        previewContainer.innerHTML = '';
        if (input.files && input.files.length > 0) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'border rounded';
                    img.style.width = '40px'; img.style.height = '40px'; img.style.objectFit = 'cover';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    // --- 3. Xử lý Danh mục AJAX ---
    function toggleAddCategory() {
        const panel = $('#addCategoryPanel');
        if (panel.is(':hidden')) {
            const mainOptions = $('#categorySelect option').clone();
            $('#newCatParent').html(mainOptions);
            $('#newCatParent').prepend('<option value="-1" selected>-- Danh mục cha (Gốc) --</option>');
            panel.slideDown();
        } else {
            panel.slideUp();
        }
    }

    function addNewCategoryAjax() {
        const name = $('#newCatName').val();
        const parentId = $('#newCatParent').find(':selected').data('id') || $('#newCatParent').val();

        if (!name) { Swal.fire('Lỗi', 'Vui lòng nhập tên', 'error'); return; }

        $.ajax({
            url: '/admin/products/api/quick-add-category',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name, parentId: parentId }),
            success: function(res) {
                const newOption = $('<option>', {
                    value: res.category.slug,
                    text: res.category.displayName,
                    'data-id': res.category.id,
                    selected: true
                });
                $('#categorySelect').append(newOption).trigger('change');
                $('#newCatName').val('');
                $('#addCategoryPanel').slideUp();

                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: 'Đã thêm danh mục!' });
            },
            error: function(err) { Swal.fire('Lỗi', 'Không thể thêm danh mục', 'error'); }
        });
    }

    // --- 4. Tags Logic ---
    function renderTags() {
        const container = document.getElementById('tag-input-container');
        const input = document.getElementById('tag-input-field');
        const hidden = document.getElementById('hidden-tags-input');

        $(container).find('.badge-tag').remove(); // Xóa tag cũ hiển thị

        tags.forEach(tag => {
            const el = document.createElement('span');
            el.className = 'badge-tag badge bg-secondary d-flex align-items-center me-1 p-2 mb-1';
            el.style.fontSize = '0.9rem';
            el.innerHTML = `${tag} <span class="ms-2 text-white" style="cursor:pointer" onclick="removeTag('${tag}')">&times;</span>`;
            container.insertBefore(el, input);
        });
        hidden.value = tags.join(',');
    }

    function removeTag(t) {
        tags = tags.filter(tag => tag !== t);
        renderTags();
    }

    // --- DOCUMENT READY ---
    $(document).ready(function() {
        // Init Tags
        const hiddenTags = $('#hidden-tags-input').val();
        if (hiddenTags) {
            tags = hiddenTags.split(',').filter(t => t.trim() !== '');
            renderTags();
        }

        // Tag Input Event
        $('#tag-input-field').on('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const val = $(this).val().trim();
                if (val && !tags.includes(val)) {
                    tags.push(val);
                    renderTags();
                }
                $(this).val('');
            } else if (e.key === 'Backspace' && !$(this).val() && tags.length > 0) {
                tags.pop();
                renderTags();
            }
        });

        $('#btn-add-tag').click(function() {
            const val = $('#tag-input-field').val().trim();
            if (val && !tags.includes(val)) {
                tags.push(val);
                renderTags();
                $('#tag-input-field').val('').focus();
            }
        });

        // Init Form Submit
        $('#productForm').on('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: 'Đang xử lý...',
                text: 'Vui lòng chờ...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            var formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    Swal.fire({
                        icon: 'success', title: 'Thành công!', text: 'Sản phẩm đã được lưu.', confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) window.location.href = "/admin/products";
                    });
                },
                error: function(xhr) {
                    Swal.close();
                    let msg = (xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : "Có lỗi xảy ra!";
                    Swal.fire({ icon: 'error', title: 'Thất bại!', text: msg });
                }
            });
        });

        // Nếu là Thêm Mới -> Auto thêm 1 dòng biến thể
        if (variantIndex === 0) addVariantRow();
    });
</script>



</body>
</html>