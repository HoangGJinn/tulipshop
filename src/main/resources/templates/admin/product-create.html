<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='Thêm sản phẩm mới')}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid bg-light py-4">
    <div class="container">
        <form action="/admin/products/create-full" method="post" enctype="multipart/form-data" th:object="${productDTO}" id="productForm">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-uppercase">Thêm sản phẩm mới</h3>
                <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold shadow-sm">ĐĂNG SẢN PHẨM</button>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Thông tin chung</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tên sản phẩm <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" th:field="*{name}" placeholder="Nhập tên sản phẩm..." required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Mô tả sản phẩm</label>
                                <textarea class="form-control" th:field="*{description}" rows="6" placeholder="Mô tả chi tiết..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Dữ liệu sản phẩm</div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="productTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active fw-bold" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">Chung</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-bold" id="variations-tab" data-bs-toggle="tab" data-bs-target="#variations" type="button" role="tab">Các biến thể</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="productTabContent">
                                <div class="tab-pane fade show active" id="general" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Giá bán thường (VNĐ)</label>
                                            <input type="number" class="form-control" th:field="*{price}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Giá khuyến mãi (VNĐ)</label>
                                            <input type="number" class="form-control" th:field="*{discountPrice}">
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="variations" role="tabpanel">
                                    <div id="variants-container">
                                    </div>

                                    <div class="d-grid mt-3">
                                        <button type="button" class="btn btn-outline-primary border-dashed" onclick="addVariantRow()">
                                            <i class="fas fa-plus-circle"></i> Thêm biến thể màu sắc
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Danh mục sản phẩm</div>
                        <div class="card-body">
                            <select class="form-select" th:field="*{categorySlug}">
                                <option th:each="cat : ${categories}" th:value="${cat.slug}" th:text="${cat.name}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Ảnh đại diện</div>
                        <div class="card-body text-center">
                            <div class="image-upload-box border rounded bg-light mb-3 d-flex align-items-center justify-content-center position-relative"
                                 style="height: 250px; cursor: pointer; overflow: hidden;"
                                 onclick="document.getElementById('mainImageInput').click()">

                                <img id="mainImagePreview" src="#" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <div id="mainImagePlaceholder" class="text-muted">
                                    <i class="fas fa-image fa-2x mb-2"></i><br>Nhấn để chọn ảnh
                                </div>

                                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle"
                                        style="display: none; width: 30px; height: 30px; padding: 0;"
                                        id="removeMainImageBtn" onclick="removeMainImage(event)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <input type="file" id="mainImageInput" class="d-none" th:field="*{mainImageFile}" accept="image/*" onchange="previewMainImage(this)">
                            <small class="text-muted">Định dạng .jpg, .png, .webp</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Phân loại (Tags)</label>
                        <div class="form-text mb-2">Nhập tag rồi nhấn <strong>Enter</strong> hoặc nút <strong>+</strong>.</div>

                        <div id="tag-input-container" class="form-control d-flex flex-wrap align-items-center gap-2" style="min-height: 45px; padding-right: 40px; position: relative;">

                            <input type="text" id="tag-input-field" class="border-0 bg-transparent shadow-none"
                                   style="outline: none; min-width: 100px; flex-grow: 1;"
                                   placeholder="Thêm tag..." />

                            <button type="button" id="btn-add-tag" class="btn btn-primary btn-sm rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 30px; height: 30px; padding: 0; position: absolute; right: 8px;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <input type="hidden" th:field="*{tags}" id="hidden-tags-input">
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('tags')}" th:errors="*{tags}"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" th:href="@{/css/notification.css}">
<script th:src="@{/js/notification.js}"></script> <template id="variant-template">
    <div class="variant-item border rounded p-3 mb-3 bg-white position-relative">
        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" onclick="removeVariantRow(this)"></button>
        <div class="row g-3">
            <div class="col-md-4 border-end">
                <h6 class="fw-bold mb-3 small text-uppercase">Thông tin màu</h6>
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm mb-1 variant-name" placeholder="Tên màu (VD: Đỏ)" required>
                </div>
                <div class="mb-2 d-flex align-items-center gap-2">
                    <input type="color" class="form-control form-control-color variant-color-code" value="#000000" title="Chọn màu">
                    <small class="text-muted">Mã màu</small>
                </div>
                <div class="mt-2">
                    <label class="btn btn-light btn-sm w-100 border text-start text-truncate">
                        <i class="fas fa-images"></i> <span class="file-name">Chọn ảnh (Nhiều)...</span>
                        <input type="file" class="d-none variant-file" accept="image/*" multiple onchange="updateFileName(this)">
                    </label>
                    <div class="variant-preview-list d-flex gap-1 mt-2 flex-wrap"></div>
                </div>
            </div>

            <div class="col-md-8">
                <h6 class="fw-bold mb-3 small text-uppercase">Số lượng tồn kho</h6>
                <div class="row g-2">
                    <div class="col-6 col-sm-4 size-input-group" th:each="size : ${allSizes}">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light fw-bold" th:text="${size.code}">S</span>
                            <input type="number" class="form-control text-center variant-stock"
                                   placeholder="0" min="0"
                                   th:data-size-code="${size.code}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script th:inline="javascript">
    $(document).ready(function() {
        // Khởi tạo dòng biến thể đầu tiên
        addVariantRow();

        // Xử lý submit form
        $('#productForm').on('submit', function(e) {
            e.preventDefault();
            // Hiển thị thông báo đang xử lý
            showNotification('attention', 'Đang xử lý...', 'Vui lòng chờ upload ảnh...', 10000);

            var formData = new FormData(this);

            $.ajax({
                url: '/admin/products/create',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: response.message,
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = response.redirectUrl || "/products";
                        }
                    });
                },
                error: function(xhr) {
                    var errorMsg = xhr.responseJSON ? xhr.responseJSON.message : "Có lỗi xảy ra!";
                    showError('Thất bại!', errorMsg);
                }
            });
        });
    });

    /* --- Logic Ảnh Chính --- */
    function previewMainImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('mainImagePreview').src = e.target.result;
                document.getElementById('mainImagePreview').style.display = 'block';
                document.getElementById('mainImagePlaceholder').style.display = 'none';
                document.getElementById('removeMainImageBtn').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeMainImage(event) {
        event.stopPropagation();
        document.getElementById('mainImageInput').value = '';
        document.getElementById('mainImagePreview').style.display = 'none';
        document.getElementById('mainImagePlaceholder').style.display = 'block';
        document.getElementById('removeMainImageBtn').style.display = 'none';
    }

    /* --- Logic Biến thể --- */
    let variantIndex = 0;

    function addVariantRow() {
        const container = document.getElementById('variants-container');
        const template = document.getElementById('variant-template');

        // Kiểm tra template tồn tại
        if (!template) {
            console.error("Không tìm thấy template biến thể!");
            return;
        }

        const clone = template.content.cloneNode(true);
        const div = clone.querySelector('.variant-item');

        // Gán name đúng chuẩn Spring Binding
        div.querySelector('.variant-name').name = `variants[${variantIndex}].colorName`;
        div.querySelector('.variant-color-code').name = `variants[${variantIndex}].colorCode`;
        div.querySelector('.variant-file').name = `variants[${variantIndex}].imageFiles`;

        div.querySelectorAll('.variant-stock').forEach(input => {
            const sizeCode = input.dataset.sizeCode;
            input.name = `variants[${variantIndex}].stockPerSize['${sizeCode}']`;
        });

        container.appendChild(div);
        variantIndex++;
    }

    function removeVariantRow(btn) {
        // Nếu muốn giữ ít nhất 1 dòng thì uncomment dòng dưới
        // if (document.querySelectorAll('.variant-item').length <= 1) return;
        btn.closest('.variant-item').remove();
    }

    function updateFileName(input) {
        const label = input.parentElement.querySelector('.file-name');
        const previewContainer = input.parentElement.nextElementSibling;
        previewContainer.innerHTML = '';

        if (input.files && input.files.length > 0) {
            label.textContent = `Đã chọn ${input.files.length} ảnh`;
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '40px';
                    img.style.height = '40px';
                    img.style.objectFit = 'cover';
                    img.className = 'border rounded';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        } else {
            label.textContent = 'Chọn ảnh (Nhiều)...';
        }
    }

    /* --- Logic Tags (Sửa đổi: Thêm bằng nút +) --- */
    document.addEventListener('DOMContentLoaded', function() {
        const tagContainer = document.getElementById('tag-input-container');
        const inputField = document.getElementById('tag-input-field');
        const hiddenInput = document.getElementById('hidden-tags-input');
        const addTagBtn = document.getElementById('btn-add-tag'); // Nút thêm tag

        let tags = (hiddenInput.value || "").split(',').filter(t => t.trim() !== '');

        function renderTags() {
            const currentBadges = tagContainer.querySelectorAll('.badge-tag');
            currentBadges.forEach(tag => tag.remove());

            tags.slice().reverse().forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'badge-tag badge bg-secondary d-flex align-items-center me-1 p-2';
                tagElement.style.fontSize = '0.9rem';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="ms-2 cursor-pointer text-white" style="cursor: pointer;" onclick="removeTag('${tag}')">&times;</span>
                `;
                // Chèn vào trước input field
                inputField.before(tagElement);
            });
        }

        function updateHiddenInput() {
            hiddenInput.value = tags.join(',');
        }

        function addTag(text) {
            const tag = text.trim();
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                renderTags();
                updateHiddenInput();
            }
            inputField.value = '';
            inputField.focus();
        }

        window.removeTag = function(tagToRemove) {
            tags = tags.filter(tag => tag !== tagToRemove);
            renderTags();
            updateHiddenInput();
        }

        // Sự kiện click nút +
        addTagBtn.addEventListener('click', function() {
            addTag(inputField.value);
        });

        // Sự kiện phím Enter hoặc Phẩy
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addTag(inputField.value);
            }
            if (e.key === 'Backspace' && inputField.value === '' && tags.length > 0) {
                tags.pop();
                renderTags();
                updateHiddenInput();
            }
        });

        tagContainer.addEventListener('click', function(e) {
            // Chỉ focus nếu không click vào nút xóa hoặc nút thêm
            if (e.target !== addTagBtn && !addTagBtn.contains(e.target)) {
                inputField.focus();
            }
        });

        renderTags();
    });
</script>

<style>
    .border-dashed {
        border-style: dashed !important;
        border-width: 2px !important;
    }
    .image-upload-box:hover {
        border-color: #0d6efd !important;
        background-color: #e9ecef !important;
    }
    /* Style cho input tag để nút + nằm đẹp */
    #tag-input-field {
        min-width: 100px;
    }
</style>

</body>
</html>
