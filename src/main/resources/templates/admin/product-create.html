<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='Th√™m s·∫£n ph·∫©m m·ªõi')}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid bg-light py-4">
    <div class="container">
        <form action="/admin/products/create-full" method="post" enctype="multipart/form-data" th:object="${productDTO}" id="productForm">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-uppercase">Th√™m s·∫£n ph·∫©m m·ªõi</h3>
                <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold shadow-sm">ƒêƒÇNG S·∫¢N PH·∫®M</button>
            </div>

            <div class="row">
                <div class="col-lg-8">

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Th√¥ng tin chung</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">T√™n s·∫£n ph·∫©m <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" th:field="*{name}" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                                <textarea class="form-control" th:field="*{description}" rows="6" placeholder="M√¥ t·∫£ chi ti·∫øt..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center">
                            <span>D·ªØ li·ªáu s·∫£n ph·∫©m</span>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="productTab" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active fw-bold" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">Chung</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link fw-bold" id="variations-tab" data-bs-toggle="tab" data-bs-target="#variations" type="button">C√°c bi·∫øn th·ªÉ</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="productTabContent">
                                <div class="tab-pane fade show active" id="general">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Gi√° b√°n th∆∞·ªùng (VNƒê)</label>
                                            <input type="number" class="form-control" th:field="*{price}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Gi√° khuy·∫øn m√£i (VNƒê)</label>
                                            <input type="number" class="form-control" th:field="*{discountPrice}">
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="variations">
                                    <div id="variants-container">
                                    </div>

                                    <div class="d-grid mt-3">
                                        <button type="button" class="btn btn-outline-primary border-dashed" onclick="addVariantRow()">
                                            <i class="fas fa-plus-circle"></i> Th√™m bi·∫øn th·ªÉ m√†u s·∫Øc
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">Danh m·ª•c s·∫£n ph·∫©m</div>
                        <div class="card-body">
                            <select class="form-select" th:field="*{categorySlug}">
                                <option th:each="cat : ${categories}" th:value="${cat.slug}" th:text="${cat.name}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white fw-bold py-3">·∫¢nh ƒë·∫°i di·ªán</div>
                        <div class="card-body text-center">
                            <div class="image-upload-box border rounded bg-light mb-3 d-flex align-items-center justify-content-center position-relative"
                                 style="height: 250px; cursor: pointer; overflow: hidden;"
                                 onclick="document.getElementById('mainImageInput').click()">

                                <img id="mainImagePreview" src="#" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <div id="mainImagePlaceholder" class="text-muted">
                                    <i class="fas fa-image fa-2x mb-2"></i><br>Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh
                                </div>

                                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle"
                                        style="display: none; width: 30px; height: 30px; padding: 0;"
                                        id="removeMainImageBtn" onclick="removeMainImage(event)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <input type="file" id="mainImageInput" class="d-none" th:field="*{mainImageFile}" accept="image/*" onchange="previewMainImage(this)">
                            <small class="text-muted">ƒê·ªãnh d·∫°ng .jpg, .png, .webp</small>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<template id="variant-template">
    <div class="variant-item border rounded p-3 mb-3 bg-white position-relative">
        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" onclick="removeVariantRow(this)"></button>
        <div class="row g-3">
            <div class="col-md-4 border-end">
                <h6 class="fw-bold mb-3 small text-uppercase">Th√¥ng tin m√†u</h6>
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm mb-1 variant-name" placeholder="T√™n m√†u (VD: ƒê·ªè)" required>
                </div>
                <div class="mb-2 d-flex align-items-center gap-2">
                    <input type="color" class="form-control form-control-color variant-color-code" value="#000000" title="Ch·ªçn m√†u">
                    <small class="text-muted">M√£ m√†u</small>
                </div>
                <div class="mt-2">
                    <label class="btn btn-light btn-sm w-100 border text-start text-truncate">
                        <i class="fas fa-upload"></i> <span class="file-name">Ch·ªçn ·∫£nh m√†u...</span>
                        <input type="file" class="d-none variant-file" accept="image/*" onchange="updateFileName(this)">
                    </label>
                </div>
            </div>

            <div class="col-md-8">
                <h6 class="fw-bold mb-3 small text-uppercase">S·ªë l∆∞·ª£ng t·ªìn kho</h6>
                <div class="row g-2">
                    <div class="col-6 col-sm-4 size-input-group" th:each="size : ${allSizes}">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light fw-bold" th:text="${size.code}">S</span>
                            <input type="number" class="form-control text-center variant-stock"
                                   placeholder="0" min="0"
                                   th:data-size-code="${size.code}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script th:inline="javascript">
    $(document).ready(function() {
        $('#productForm').on('submit', function(e) {
            e.preventDefault(); // 1. Ch·∫∑n tr√¨nh duy·ªát reload trang

            // Hi·ªÉn th·ªã loading (t√πy ch·ªçn)
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // 2. T·∫°o ƒë·ªëi t∆∞·ª£ng FormData t·ª´ form
            // FormData s·∫Ω t·ª± ƒë·ªông l·∫•y t·∫•t c·∫£ input c√≥ attribute 'name' (bao g·ªìm c·∫£ file)
            var formData = new FormData(this);

            // 3. G·ªçi AJAX (Theo h∆∞·ªõng d·∫´n PDF)
            $.ajax({
                // üëá S·ª¨A ƒê∆Ø·ªúNG D·∫™N T·∫†I ƒê√ÇY (Tr√πng v·ªõi @RequestMapping c·ªßa Controller)
                url: '/admin/products/create',
                type: 'POST',
                data: formData,

                processData: false,
                contentType: false,

                success: function(response) {
                    Swal.close();
                    Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng!',
                        text: response.message,
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Chuy·ªÉn h∆∞·ªõng theo link server tr·∫£ v·ªÅ ho·∫∑c m·∫∑c ƒë·ªãnh
                            window.location.href = response.redirectUrl || "/products";
                        }
                    });
                },

                error: function(xhr, status, error) {
                    Swal.close();

                    var errorMsg = "C√≥ l·ªói x·∫£y ra!";
                    if(xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'Th·∫•t b·∫°i!',
                        text: errorMsg
                    });
                    console.error(error);
                }
            });
        });
    });


    /* --- 1. X·ª≠ l√Ω ·∫¢nh Ch√≠nh (Preview & Remove) --- */
    function previewMainImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('mainImagePreview').src = e.target.result;
                document.getElementById('mainImagePreview').style.display = 'block';
                document.getElementById('mainImagePlaceholder').style.display = 'none';
                document.getElementById('removeMainImageBtn').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeMainImage(event) {
        event.stopPropagation(); // Ch·∫∑n click lan ra box cha (g√¢y m·ªü l·∫°i file dialog)
        const input = document.getElementById('mainImageInput');
        input.value = ''; // Reset input file

        document.getElementById('mainImagePreview').src = '#';
        document.getElementById('mainImagePreview').style.display = 'none';
        document.getElementById('mainImagePlaceholder').style.display = 'block';
        document.getElementById('removeMainImageBtn').style.display = 'none';
    }

    /* --- 2. X·ª≠ l√Ω Variants ƒê·ªông (Dynamic Form) --- */
    let variantIndex = 0;

    function addVariantRow() {
        const container = document.getElementById('variants-container');
        const template = document.getElementById('variant-template').content.cloneNode(true);
        const div = template.querySelector('.variant-item');

        // G√°n name attribute cho c√°c input ƒë·ªÉ Spring Boot hi·ªÉu ƒë∆∞·ª£c List<VariantInput>
        // C·∫•u tr√∫c name: variants[0].colorName, variants[0].stockPerSize['S']...

        // 1. T√™n m√†u
        div.querySelector('.variant-name').name = `variants[${variantIndex}].colorName`;

        // 2. M√£ m√†u
        div.querySelector('.variant-color-code').name = `variants[${variantIndex}].colorCode`;

        // 3. File ·∫£nh
        div.querySelector('.variant-file').name = `variants[${variantIndex}].imageFile`;

        // 4. Stock inputs
        div.querySelectorAll('.variant-stock').forEach(input => {
            const sizeCode = input.getAttribute('data-size-code');
            input.name = `variants[${variantIndex}].stockPerSize['${sizeCode}']`;
        });

        container.appendChild(div);
        variantIndex++;
    }

    function removeVariantRow(btn) {
        btn.closest('.variant-item').remove();
        // L∆∞u √Ω: Khi x√≥a, index s·∫Ω b·ªã ƒë·ª©t qu√£ng (0, 2, 3...).
        // Spring Boot List v·∫´n bind ƒë∆∞·ª£c, nh∆∞ng c√≥ th·ªÉ t·∫°o ph·∫ßn t·ª≠ null.
        // ƒê·ªÉ ƒë∆°n gi·∫£n ta ch·∫•p nh·∫≠n logic n√†y cho tutorial.
    }

    function updateFileName(input) {
        const label = input.parentElement.querySelector('.file-name');
        if (input.files && input.files[0]) {
            label.textContent = input.files[0].name;
        } else {
            label.textContent = 'Ch·ªçn ·∫£nh m√†u...';
        }
    }

    // T·ª± ƒë·ªông th√™m 1 d√≤ng variant khi load trang
    document.addEventListener('DOMContentLoaded', () => {
        addVariantRow();
    });
</script>

<style>
    .border-dashed {
        border-style: dashed !important;
        border-width: 2px !important;
    }
    .image-upload-box:hover {
        border-color: #0d6efd !important;
        background-color: #e9ecef !important;
    }
</style>

</body>
</html>