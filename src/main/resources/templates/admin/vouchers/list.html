<div th:fragment="content">
    <div th:replace="~{admin/fragments/common :: tableLayout(
        title='Voucher Collection',
        addBtnText='Thêm Voucher',
        searchPlaceholder='TÌM THEO MÃ VOUCHER...',
        tableHeaders=${tableHeaders}
    )}"></div>

    <script th:inline="javascript">
        // 1. Hàm fetch dữ liệu từ API
        async function loadVoucherData() {
            try {
                const response = await fetch('/v1/api/admin/vouchers');
                if (!response.ok) throw new Error('Failed to fetch vouchers');

                const vouchers = await response.json();
                const tbody = document.getElementById('table-body-data');
                const countLabel = document.getElementById('data-count');

                if (!vouchers || vouchers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="p-20 text-center">
                                <p class="text-[10px] tracking-[0.5em] uppercase text-gray-400">Chưa có voucher nào</p>
                            </td>
                        </tr>
                    `;
                    countLabel.innerText = '0 Items';
                    return;
                }

                countLabel.innerText = `${vouchers.length} Items`;
                tbody.innerHTML = vouchers.map(v => `
                    <tr class="hover:bg-gray-50/50 transition-colors border-b border-gray-50 last:border-none">
                        <td class="p-4">
                            <span class="font-black text-sm uppercase tracking-wider bg-gray-100 px-3 py-1 rounded">${v.code || 'N/A'}</span>
                        </td>
                        <td class="p-4">
                            <span class="text-[10px] font-bold uppercase ${v.type === 'PERCENT' ? 'text-purple-600' : 'text-blue-600'}">
                                ${v.type === 'PERCENT' ? '% Phần trăm' : '₫ Số tiền'}
                            </span>
                        </td>
                        <td class="p-4 font-black text-sm">
                            ${v.type === 'PERCENT' 
                                ? v.discountValue + '%' 
                                : new Intl.NumberFormat('vi-VN').format(v.discountValue || 0) + '₫'}
                        </td>
                        <td class="p-4 text-xs text-gray-500">
                            ${v.minOrderValue ? new Intl.NumberFormat('vi-VN').format(v.minOrderValue) + '₫' : 'Không yêu cầu'}
                        </td>
                        <td class="p-4 text-center font-bold">${v.quantity || 0}</td>
                        <td class="p-4 text-center">
                            <span class="text-xs ${v.remaining <= 0 ? 'text-red-500' : 'text-green-600'} font-bold">
                                ${v.usedCount || 0}/${v.quantity || 0}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="text-[10px] text-gray-500">
                                <div>Từ: ${v.startAt || 'N/A'}</div>
                                <div>Đến: ${v.expireAt}</div>
                            </div>
                        </td>
                        <td class="p-4">
                            ${v.isValid 
                                ? '<span class="inline-flex items-center gap-1 text-[10px] font-bold uppercase text-green-600 bg-green-50 px-2 py-1 rounded"><i data-lucide="check-circle" class="w-3 h-3"></i>Hoạt động</span>'
                                : '<span class="inline-flex items-center gap-1 text-[10px] font-bold uppercase text-red-500 bg-red-50 px-2 py-1 rounded"><i data-lucide="x-circle" class="w-3 h-3"></i>Hết hạn</span>'}
                        </td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-4">
                                <a href="/admin/vouchers/form?id=${v.id}"
                                   class="text-[10px] font-black uppercase tracking-widest hover:underline hover:text-blue-600 transition-colors">
                                   Sửa
                                </a>
                                <button onclick="deleteVoucher(${v.id})"
                                   class="text-[10px] font-black uppercase tracking-widest text-red-500 hover:underline transition-colors">
                                   Xóa
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // Re-init lucide icons for the new content
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
                document.getElementById('table-body-data').innerHTML = `
                    <tr>
                        <td colspan="9" class="p-20 text-center">
                            <p class="text-[10px] tracking-[0.5em] uppercase text-red-500">Lỗi tải dữ liệu hệ thống</p>
                        </td>
                    </tr>
                `;
            }
        }

        // 2. Hàm xóa voucher
        function deleteVoucher(id) {
            showConfirmModal(
                'Xóa voucher',
                'Bạn có chắc chắn muốn xóa voucher này? Hành động này không thể hoàn tác.',
                async function() {
                    try {
                        const response = await fetch(`/v1/api/admin/vouchers/${id}`, { method: 'DELETE' });
                        if (response.ok) {
                            showNotification('success', 'Thành công', 'Đã xóa voucher khỏi hệ thống');
                            loadVoucherData(); // Reload danh sách
                        } else {
                            showNotification('error', 'Lỗi', 'Không thể xóa voucher vào lúc này');
                        }
                    } catch (error) {
                        showNotification('error', 'Lỗi', 'Có lỗi xảy ra khi kết nối máy chủ');
                    }
                }
            );
        }

        // 3. Hàm tìm kiếm
        function handleSearch() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#table-body-data tr');

            rows.forEach(row => {
                if (row.cells.length > 1) {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                }
            });
        }

        // 4. Hàm điều hướng khi bấm nút "Thêm Voucher"
        function openAddDialog() {
            window.location.href = '/admin/vouchers/form';
        }

        // Khởi tạo dữ liệu khi trang load xong
        document.addEventListener('DOMContentLoaded', loadVoucherData);
    </script>
</div>
