<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">
    <style>
        .tox-tinymce { border: 1px solid #e5e7eb !important; border-radius: 0.75rem !important; overflow: hidden; }
        .variant-item { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
        <form th:action="@{/admin/products/save}" method="post" enctype="multipart/form-data"
              th:object="${productDTO}" id="productForm" class="pb-20">

            <input type="hidden" th:field="*{id}">
            <input type="hidden" th:field="*{thumbnailUrl}">

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl font-black uppercase tracking-tighter text-gray-900"
                        th:text="${isEditMode} ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m' : 'ƒêƒÉng s·∫£n ph·∫©m m·ªõi'"></h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mt-1 italic">TulipShop / Inventory Management</p>
                </div>
                <div class="flex gap-3">
                    <a th:href="@{/admin/products}" class="px-6 py-3 text-[10px] font-black uppercase tracking-widest border border-gray-200 bg-white hover:bg-gray-50 transition-all">H·ªßy</a>
                    <button type="submit" class="bg-black text-white px-8 py-3 text-[10px] font-black uppercase tracking-[0.2em] hover:bg-gray-800 transition-all shadow-xl active:scale-95">
                        <span th:text="${isEditMode} ? 'L∆∞u thay ƒë·ªïi' : 'ƒêƒÉng s·∫£n ph·∫©m'"></span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <div class="lg:col-span-8 space-y-6">

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-6 border-b pb-2 flex items-center gap-2">
                            <i data-lucide="info" class="w-3 h-3"></i> Th√¥ng tin c∆° b·∫£n
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">T√™n s·∫£n ph·∫©m <span class="text-red-500">*</span></label>
                                <input type="text" th:field="*{name}" required
                                       class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm focus:border-black outline-none transition-all placeholder:text-gray-300"
                                       placeholder="√Åo s∆° mi l·ª•a Tulip Premium...">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2 flex items-center justify-between">
                                    <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>
                                    <button type="button" id="aiGenerateBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 text-[9px] font-black uppercase tracking-widest rounded-lg hover:shadow-lg transition-all flex items-center gap-2">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> ‚ú® S√°ng t·∫°o c√πng AI
                                    </button>
                                </label>
                                <textarea th:field="*{description}" id="productDescription"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <div class="flex gap-8 border-b border-gray-100 mb-6">
                            <button type="button" class="tab-btn active pb-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-black" data-target="#pane-general">Thi·∫øt l·∫≠p gi√°</button>
                            <button type="button" class="tab-btn pb-4 text-[10px] font-black uppercase tracking-widest text-gray-400 hover:text-black transition-colors" data-target="#pane-variants">Qu·∫£n l√Ω bi·∫øn th·ªÉ & Kho</button>
                        </div>

                        <div class="tab-panes">
                            <div id="pane-general" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">Gi√° ni√™m y·∫øt (‚Ç´)</label>
                                        <div class="relative">
                                            <input type="number" th:field="*{price}" required
                                                   class="w-full border border-gray-200 rounded-lg pl-4 pr-10 py-2.5 text-sm focus:border-black outline-none font-bold">
                                            <span class="absolute right-4 top-2.5 text-gray-400 text-xs font-bold">‚Ç´</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">Gi√° khuy·∫øn m√£i (‚Ç´)</label>
                                        <div class="relative">
                                            <input type="number" th:field="*{discountPrice}"
                                                   class="w-full border border-gray-200 rounded-lg pl-4 pr-10 py-2.5 text-sm focus:border-black outline-none font-bold text-red-500">
                                            <span class="absolute right-4 top-2.5 text-gray-400 text-xs font-bold">‚Ç´</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="pane-variants" class="hidden space-y-4">
                                <div id="variants-container" class="space-y-6">
                                    <div th:each="variant, stat : *{variants}" class="variant-item bg-gray-50 border border-gray-200 rounded-xl p-6 relative group">
                                        <button type="button" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors" onclick="removeVariantRow(this)">
                                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                                        </button>

                                        <input type="hidden" th:name="|variants[${stat.index}].id|" th:value="${variant.id}">

                                        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                                            <div class="md:col-span-4 space-y-4">
                                                <div>
                                                    <label class="text-[9px] font-black text-gray-400 uppercase mb-2 block">Ph√¢n lo·∫°i m√†u</label>
                                                    <input type="text" placeholder="T√™n m√†u" required
                                                           class="w-full border border-gray-200 rounded px-3 py-2 text-xs font-bold uppercase outline-none focus:border-black"
                                                           th:name="|variants[${stat.index}].colorName|" th:value="${variant.colorName}">
                                                </div>
                                                <div class="flex items-center gap-3">
                                                    <input type="color" class="h-10 w-16 border-none p-0 cursor-pointer bg-transparent"
                                                           th:name="|variants[${stat.index}].colorCode|" th:value="${variant.colorCode}">
                                                    <span class="text-[9px] font-black text-gray-500 uppercase tracking-tighter">M√£ m√†u HEX</span>
                                                </div>
                                                <div>
                                                    <label class="block cursor-pointer bg-white border-2 border-dashed border-gray-200 text-center py-3 text-[10px] font-black uppercase hover:border-black transition-all">
                                                        <i data-lucide="upload-cloud" class="w-4 h-4 mx-auto mb-1"></i> + Upload ·∫£nh m√†u
                                                        <input type="file" class="hidden variant-file" accept="image/*" multiple onchange="updateFileName(this)" th:name="|variants[${stat.index}].imageFiles|">
                                                    </label>
                                                    <div class="variant-preview-list flex flex-wrap gap-2 mt-3">
                                                        <img th:each="url : ${variant.imageUrls}" th:src="${url}" class="w-12 h-12 object-cover border border-black rounded shadow-sm">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="md:col-span-8">
                                                <label class="text-[9px] font-black text-gray-400 uppercase mb-4 block tracking-widest">T√¨nh tr·∫°ng kho h√†ng (Size)</label>
                                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                                    <div th:each="size : ${allSizes}" class="flex flex-col border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                                                        <div class="bg-gray-50 text-[10px] font-black py-1 text-center border-b border-gray-200" th:text="${size.code}"></div>
                                                        <input type="number" class="w-full px-2 py-2 text-center text-sm font-bold outline-none focus:bg-gray-50"
                                                               placeholder="0" min="0"
                                                               th:name="|variants[${stat.index}].stockPerSize['${size.code}']|"
                                                               th:value="${variant.stockPerSize != null ? (variant.stockPerSize.get(size.code) ?: 0) : 0}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addVariantRow()" class="w-full border-2 border-dashed border-gray-200 py-6 text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 hover:border-black hover:text-black transition-all rounded-xl">
                                    + Th√™m bi·∫øn th·ªÉ s·∫£n ph·∫©m m·ªõi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 space-y-6">

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Tr·∫°ng th√°i s·∫£n ph·∫©m</h2>
                        <select th:field="*{status}" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm font-bold outline-none focus:border-black">
                            <option value="ACTIVE">Ho·∫°t ƒë·ªông</option>
                            <option value="HIDDEN">·∫®n</option>
                        </select>
                        <p class="text-[9px] text-gray-400 mt-2 italic">
                            <strong>Ho·∫°t ƒë·ªông:</strong> Hi·ªÉn th·ªã tr√™n website<br>
                            <strong>·∫®n:</strong> Kh√¥ng hi·ªÉn th·ªã tr√™n website
                        </p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">·∫¢nh ƒë·∫°i di·ªán</h2>
                        <div class="relative group cursor-pointer border-2 border-dashed border-gray-200 rounded-xl overflow-hidden aspect-[3/4] flex items-center justify-center bg-gray-50 hover:bg-gray-100 transition-all"
                             onclick="document.getElementById('mainImageInput').click()">

                            <img id="mainImagePreview" class="absolute inset-0 w-full h-full object-contain p-2 hidden" src="#">
                            <img id="currentImage" th:if="${productDTO.thumbnailUrl != null}" th:src="${productDTO.thumbnailUrl}" class="absolute inset-0 w-full h-full object-contain p-2">

                            <div id="mainImagePlaceholder" class="text-center z-10" th:style="${productDTO.thumbnailUrl != null ? 'display: none;' : 'display: block;'}">
                                <i data-lucide="image" class="w-10 h-10 mx-auto text-gray-300 mb-2"></i>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">T·∫£i ·∫£nh ƒë·∫°i di·ªán</p>
                            </div>
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span class="text-white text-[10px] font-black uppercase">Thay ƒë·ªïi ·∫£nh</span>
                            </div>
                        </div>
                        <input type="file" id="mainImageInput" class="hidden" th:field="*{mainImageFile}" accept="image/*" onchange="previewMainImage(this)">
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Danh m·ª•c</h2>
                        <select id="categorySelect" th:field="*{categorySlug}" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm font-bold outline-none focus:border-black appearance-none bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1jaGV2cm9uLWRvd24iPjxwYXRoIGQ9Im02IDkgNiA2IDYtNiIvPjwvc3ZnPg==')] bg-[length:16px_16px] bg-[right_1rem_center] bg-no-repeat">
                            <option value="" disabled selected>-- Ch·ªçn danh m·ª•c s·∫£n ph·∫©m --</option>
                            <option th:each="cat : ${categories}" th:value="${cat.slug}" th:text="${cat.displayName}" th:data-id="${cat.id}"></option>
                        </select>

                        <button type="button" onclick="toggleAddCategory()" class="mt-4 text-[9px] font-black text-gray-400 uppercase hover:text-black tracking-[0.2em] transition-colors">+ Th√™m danh m·ª•c m·ªõi</button>

                        <div id="addCategoryPanel" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-xl space-y-3">
                            <input type="text" id="newCatName" placeholder="T√™n danh m·ª•c..." class="w-full px-3 py-2 text-xs border border-gray-200 rounded outline-none focus:border-black">
                            <select id="newCatParent" class="w-full px-3 py-2 text-[10px] font-bold border border-gray-200 rounded outline-none">
                                <option value="-1">-- Danh m·ª•c g·ªëc --</option>
                            </select>
                            <button type="button" onclick="addNewCategoryAjax()" class="w-full bg-black text-white py-2 text-[10px] font-black uppercase tracking-widest hover:bg-gray-800 transition-all">X√°c nh·∫≠n th√™m</button>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Thu·ªôc t√≠nh k·ªπ thu·∫≠t</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-[9px] font-black uppercase tracking-widest text-gray-700 mb-2">Ki·ªÉu c·ªï √°o</label>
                                <select th:field="*{neckline}" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm font-bold outline-none focus:border-black neckline-select">
                                    <option value="">-- Ch·ªçn ki·ªÉu c·ªï --</option>
                                    <option value="C·ªï tr√≤n">C·ªï tr√≤n</option>
                                    <option value="C·ªï V">C·ªï V</option>
                                    <option value="C·ªï s∆° mi">C·ªï s∆° mi</option>
                                    <option value="C·ªï vu√¥ng">C·ªï vu√¥ng</option>
                                    <option value="C·ªï y·∫øm">C·ªï y·∫øm</option>
                                    <option value="C·ªï l·ªç">C·ªï l·ªç</option>
                                    <option value="C·ªï thuy·ªÅn">C·ªï thuy·ªÅn</option>
                                    <option value="OTHER">Kh√°c...</option>
                                </select>
                                <input type="text" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm mt-2 hidden neckline-custom" placeholder="Nh·∫≠p ki·ªÉu c·ªï t√πy ch·ªânh...">
                            </div>
                            
                            <div>
                                <label class="block text-[9px] font-black uppercase tracking-widest text-gray-700 mb-2">Ch·∫•t li·ªáu</label>
                                <select th:field="*{material}" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm font-bold outline-none focus:border-black material-select">
                                    <option value="">-- Ch·ªçn ch·∫•t li·ªáu --</option>
                                    <option value="Cotton">Cotton</option>
                                    <option value="L·ª•a">L·ª•a</option>
                                    <option value="V·∫£i thun">V·∫£i thun</option>
                                    <option value="Kaki">Kaki</option>
                                    <option value="Jean">Jean</option>
                                    <option value="Linen">Linen</option>
                                    <option value="Polyester">Polyester</option>
                                    <option value="V·∫£i ren">V·∫£i ren</option>
                                    <option value="OTHER">Kh√°c...</option>
                                </select>
                                <input type="text" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm mt-2 hidden material-custom" placeholder="Nh·∫≠p ch·∫•t li·ªáu t√πy ch·ªânh...">
                            </div>
                            
                            <div>
                                <label class="block text-[9px] font-black uppercase tracking-widest text-gray-700 mb-2">Ki·ªÉu tay √°o</label>
                                <select th:field="*{sleeveType}" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm font-bold outline-none focus:border-black sleeve-select">
                                    <option value="">-- Ch·ªçn ki·ªÉu tay --</option>
                                    <option value="Tay ng·∫Øn">Tay ng·∫Øn</option>
                                    <option value="Tay d√†i">Tay d√†i</option>
                                    <option value="Tay l·ª°">Tay l·ª°</option>
                                    <option value="Tay l·ª≠ng">Tay l·ª≠ng</option>
                                    <option value="Kh√¥ng tay">Kh√¥ng tay</option>
                                    <option value="Tay b·ªìng">Tay b·ªìng</option>
                                    <option value="Tay raglan">Tay raglan</option>
                                    <option value="OTHER">Kh√°c...</option>
                                </select>
                                <input type="text" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm mt-2 hidden sleeve-custom" placeholder="Nh·∫≠p ki·ªÉu tay t√πy ch·ªânh...">
                            </div>
                            
                            <div>
                                <label class="block text-[9px] font-black uppercase tracking-widest text-gray-700 mb-2">Nh√£n hi·ªáu</label>
                                <select th:field="*{brand}" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm font-bold outline-none focus:border-black brand-select">
                                    <option value="">-- Ch·ªçn nh√£n hi·ªáu --</option>
                                    <option value="TulipShop">TulipShop</option>
                                    <option value="Zara">Zara</option>
                                    <option value="H&M">H&M</option>
                                    <option value="Uniqlo">Uniqlo</option>
                                    <option value="Mango">Mango</option>
                                    <option value="OTHER">Kh√°c...</option>
                                </select>
                                <input type="text" class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-sm mt-2 hidden brand-custom" placeholder="Nh·∫≠p nh√£n hi·ªáu t√πy ch·ªânh...">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Nh√£n s·∫£n ph·∫©m (Tags)</h2>
                        <div id="tag-input-container" class="flex flex-wrap gap-2 border border-gray-200 rounded-lg p-3 min-h-[50px] focus-within:border-black transition-all bg-white">
                            <input type="text" id="tag-input-field" class="outline-none text-xs flex-1 min-w-[80px]" placeholder="Nh·∫≠p nh√£n...">
                        </div>
                        <input type="hidden" th:field="*{tags}" id="hidden-tags-input">
                        <p class="text-[9px] text-gray-400 mt-2 italic italic">G√µ t√™n tag v√† nh·∫•n Enter ho·∫∑c D·∫•u ph·∫©y</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<template id="variant-template">
    <div class="variant-item bg-gray-50 border border-gray-200 rounded-xl p-6 relative group">
        <button type="button" class="absolute top-4 right-4 text-gray-300 hover:text-red-500" onclick="removeVariantRow(this)">
            <i data-lucide="x-circle" class="w-5 h-5"></i>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
            <div class="md:col-span-4 space-y-4">
                <div>
                    <label class="text-[9px] font-black text-gray-400 uppercase mb-2 block">Ph√¢n lo·∫°i m√†u</label>
                    <input type="text" placeholder="T√™n m√†u" required class="w-full border border-gray-200 rounded px-3 py-2 text-xs font-bold uppercase variant-name">
                </div>
                <div class="flex items-center gap-3">
                    <input type="color" class="h-10 w-16 border-none p-0 cursor-pointer bg-transparent variant-color-code" value="#000000">
                    <span class="text-[9px] font-black text-gray-500 uppercase tracking-tighter">M√£ m√†u HEX</span>
                </div>
                <div>
                    <label class="block cursor-pointer bg-white border-2 border-dashed border-gray-200 text-center py-3 text-[10px] font-black uppercase hover:border-black transition-all">
                        + Upload ·∫£nh m√†u
                        <input type="file" class="hidden variant-file" accept="image/*" multiple onchange="updateFileName(this)">
                    </label>
                    <div class="variant-preview-list flex flex-wrap gap-2 mt-3"></div>
                </div>
            </div>
            <div class="md:col-span-8">
                <label class="text-[9px] font-black text-gray-400 uppercase mb-4 block tracking-widest">T√¨nh tr·∫°ng kho h√†ng (Size)</label>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                    <div th:each="size : ${allSizes}" class="flex flex-col border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                        <div class="bg-gray-50 text-[10px] font-black py-1 text-center border-b border-gray-200" th:text="${size.code}"></div>
                        <input type="number" class="w-full px-2 py-2 text-center text-sm font-bold outline-none variant-stock"
                               placeholder="0" min="0" th:data-size-code="${size.code}">
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.tiny.cloud/1/we6asp3e5hwysfsm9y5hbkwdh260fckl3vk4g2p38g97axz3/tinymce/7/tinymce.min.js"></script>

<script th:inline="javascript">
    /* Bi·∫øn t·ª´ Thymeleaf */
    let variantIndex = /*[[${productDTO.variants != null ? productDTO.variants.size() : 0}]]*/ 0;
    let tags = [];

    // --- 1. TABS LOGIC ---
    $('.tab-btn').click(function() {
        const target = $(this).data('target');
        $('.tab-btn').removeClass('active border-black text-black').addClass('text-gray-400');
        $(this).addClass('active border-black text-black').removeClass('text-gray-400');
        $('#pane-general, #pane-variants').addClass('hidden');
        $(target).removeClass('hidden');
    });
    
    // --- 1.5. THU·ªòC T√çNH K·ª∏ THU·∫¨T - DROPDOWN "KH√ÅC" ---
    function setupCustomDropdown(selectClass, inputClass, fieldName) {
        $(document).on('change', selectClass, function() {
            const customInput = $(this).siblings(inputClass);
            if ($(this).val() === 'OTHER') {
                customInput.removeClass('hidden').focus();
                customInput.attr('name', fieldName);
                $(this).removeAttr('name');
            } else {
                customInput.addClass('hidden').val('');
                customInput.removeAttr('name');
                $(this).attr('name', fieldName);
            }
        });
        
        // Kh√¥i ph·ª•c gi√° tr·ªã t√πy ch·ªânh khi edit
        const currentVal = $(selectClass).val();
        if (currentVal && !$(selectClass + ' option[value="' + currentVal + '"]').length) {
            $(selectClass).val('OTHER').trigger('change');
            $(selectClass).siblings(inputClass).val(currentVal);
        }
    }
    
    setupCustomDropdown('.neckline-select', '.neckline-custom', 'neckline');
    setupCustomDropdown('.material-select', '.material-custom', 'material');
    setupCustomDropdown('.sleeve-select', '.sleeve-custom', 'sleeveType');
    setupCustomDropdown('.brand-select', '.brand-custom', 'brand');
    
    // --- 1.6. AI GENERATE DESCRIPTION ---
    $('#aiGenerateBtn').click(async function() {
        const productName = $('input[name="name"]').val();
        const neckline = $('.neckline-select').val() === 'OTHER' ? $('.neckline-custom').val() : $('.neckline-select').val();
        const material = $('.material-select').val() === 'OTHER' ? $('.material-custom').val() : $('.material-select').val();
        const sleeveType = $('.sleeve-select').val() === 'OTHER' ? $('.sleeve-custom').val() : $('.sleeve-select').val();
        const brand = $('.brand-select').val() === 'OTHER' ? $('.brand-custom').val() : $('.brand-select').val();
        
        if (!productName) {
            Swal.fire({ icon: 'warning', title: 'Thi·∫øu th√¥ng tin', text: 'Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m tr∆∞·ªõc!' });
            return;
        }
        
        // Ki·ªÉm tra xem c√≥ ·∫£nh kh√¥ng
        const mainImageInput = document.getElementById('mainImageInput');
        const currentImageSrc = $('#currentImage').attr('src');
        const hiddenThumbnailUrl = $('input[name="thumbnailUrl"]').val();
        
        let cloudinaryUrl = null;
        
        // N·∫øu c√≥ ·∫£nh m·ªõi ƒë∆∞·ª£c ch·ªçn, upload l√™n Cloudinary tr∆∞·ªõc
        if (mainImageInput.files && mainImageInput.files[0]) {
            Swal.fire({
                title: 'üì§ ƒêANG T·∫¢I ·∫¢NH L√äN',
                html: '<div class="text-sm text-gray-600">ƒêang upload ·∫£nh l√™n Cloudinary...</div>',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            
            const formData = new FormData();
            formData.append('file', mainImageInput.files[0]);
            
            try {
                const uploadResponse = await $.ajax({
                    url: '/v1/api/admin/products/upload-image',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false
                });
                
                cloudinaryUrl = uploadResponse.location;
                // L∆∞u URL v√†o hidden field ƒë·ªÉ d√πng khi submit form
                $('input[name="thumbnailUrl"]').val(cloudinaryUrl);
                
            } catch (error) {
                Swal.fire({ 
                    icon: 'error', 
                    title: 'L·ªñI UPLOAD ·∫¢NH', 
                    text: 'Kh√¥ng th·ªÉ upload ·∫£nh l√™n Cloudinary. Vui l√≤ng th·ª≠ l·∫°i!' 
                });
                return;
            }
        } else if (currentImageSrc && currentImageSrc !== '#') {
            // N·∫øu ƒëang edit v√† c√≥ ·∫£nh c≈©
            cloudinaryUrl = currentImageSrc;
        } else if (hiddenThumbnailUrl) {
            // N·∫øu c√≥ URL trong hidden field
            cloudinaryUrl = hiddenThumbnailUrl;
        } else {
            Swal.fire({ icon: 'warning', title: 'Thi·∫øu h√¨nh ·∫£nh', text: 'Vui l√≤ng t·∫£i ·∫£nh ƒë·∫°i di·ªán tr∆∞·ªõc!' });
            return;
        }
        
        // B√¢y gi·ªù g·ªçi AI v·ªõi URL Cloudinary
        Swal.fire({
            title: '‚ú® CHUY√äN GIA AI ƒêANG L√ÄM VI·ªÜC',
            html: '<div class="text-sm text-gray-600">ƒêang ph√¢n t√≠ch h√¨nh ·∫£nh v√† thi·∫øt k·∫ø n·ªôi dung s√°ng t·∫°o...</div>',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        $.ajax({
            url: '/v1/api/admin/ai/generate-description',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                productName: productName,
                thumbnailUrl: cloudinaryUrl,  // G·ª≠i URL Cloudinary, KH√îNG ph·∫£i Base64
                neckline: neckline || 'Kh√¥ng x√°c ƒë·ªãnh',
                material: material || 'Kh√¥ng x√°c ƒë·ªãnh',
                sleeveType: sleeveType || 'Kh√¥ng x√°c ƒë·ªãnh',
                brand: brand || 'TulipShop'
            }),
            success: function(response) {
                Swal.close();
                if (response.success && response.htmlContent) {
                    tinymce.get('productDescription').setContent(response.htmlContent);
                    Swal.fire({
                        icon: 'success',
                        title: 'üé® HO√ÄN TH√ÄNH',
                        text: 'N·ªôi dung ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi AI Fashion Expert!',
                        confirmButtonColor: '#000'
                    });
                } else {
                    Swal.fire({ icon: 'error', title: 'L·ªói', text: response.message || 'Kh√¥ng th·ªÉ t·∫°o n·ªôi dung' });
                }
            },
            error: function(xhr) {
                Swal.fire({ 
                    icon: 'error', 
                    title: 'L·ªñI K·∫æT N·ªêI AI', 
                    text: xhr.responseJSON?.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI Service' 
                });
            }
        });
    });

    // --- 2. ·∫¢NH ƒê·∫†I DI·ªÜN ---
    function previewMainImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                $('#mainImagePreview').attr('src', e.target.result).fadeIn().removeClass('hidden');
                $('#currentImage, #mainImagePlaceholder').fadeOut().addClass('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 3. BI·∫æN TH·ªÇ (VARIANTS) ---
    function addVariantRow() {
        const container = document.getElementById('variants-container');
        const template = document.getElementById('variant-template');
        const clone = template.content.cloneNode(true);
        const div = clone.querySelector('.variant-item');

        div.querySelector('.variant-name').name = `variants[${variantIndex}].colorName`;
        div.querySelector('.variant-color-code').name = `variants[${variantIndex}].colorCode`;
        div.querySelector('.variant-file').name = `variants[${variantIndex}].imageFiles`;

        div.querySelectorAll('.variant-stock').forEach(input => {
            const sc = input.getAttribute('data-size-code');
            input.name = `variants[${variantIndex}].stockPerSize['${sc}']`;
            input.value = 0;
        });

        container.appendChild(div);
        variantIndex++;
        lucide.createIcons();
    }

    function removeVariantRow(btn) {
        $(btn).closest('.variant-item').fadeOut(300, function() { $(this).remove(); });
    }

    function updateFileName(input) {
        const preview = input.parentElement.nextElementSibling;
        preview.innerHTML = '';
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = `<img src="${e.target.result}" class="w-12 h-12 object-cover border border-black rounded shadow-sm">`;
                preview.innerHTML += img;
            }
            reader.readAsDataURL(file);
        });
    }

    // --- 4. DANH M·ª§C AJAX ---
    function toggleAddCategory() {
        const panel = $('#addCategoryPanel');
        if (panel.is(':hidden')) {
            const options = $('#categorySelect option').clone();
            $('#newCatParent').empty().append('<option value="-1">-- Danh m·ª•c g·ªëc --</option>');
            options.each(function() {
                if($(this).val()) $('#newCatParent').append($(this));
            });
            panel.slideDown();
        } else { panel.slideUp(); }
    }

    function addNewCategoryAjax() {
        const name = $('#newCatName').val();
        const parentId = $('#newCatParent').find(':selected').data('id') || -1;
        if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c'); return; }

        $.ajax({
            url: '/v1/api/admin/products/quick-add-category',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name, parentId: parentId }),
            success: function(res) {
                const newOpt = `<option value="${res.category.slug}" data-id="${res.category.id}" selected>${res.category.displayName}</option>`;
                $('#categorySelect').append(newOpt);
                $('#newCatName').val('');
                $('#addCategoryPanel').slideUp();
            }
        });
    }

    // --- 5. TAGS LOGIC ---
    function renderTags() {
        const container = $('#tag-input-container');
        container.find('.tag-badge').remove();
        tags.forEach(t => {
            const html = `<span class="tag-badge bg-black text-white text-[9px] font-black uppercase tracking-widest px-2 py-1.5 rounded flex items-center gap-2">
                    ${t} <button type="button" onclick="removeTag('${t}')" class="hover:text-red-400">√ó</button>
                </span>`;
            $('#tag-input-field').before(html);
        });
        $('#hidden-tags-input').val(tags.join(','));
    }

    function removeTag(t) { tags = tags.filter(tag => tag !== t); renderTags(); }

    // --- 6. TINYMCE & SUBMIT ---
    $(document).ready(function() {
        // Init Tags
        const curTags = $('#hidden-tags-input').val();
        if (curTags) { tags = curTags.split(',').filter(x => x.trim()!==''); renderTags(); }

        $('#tag-input-field').on('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const v = $(this).val().trim();
                if (v && !tags.includes(v)) { tags.push(v); renderTags(); }
                $(this).val('');
            }
        });

        // TinyMCE Editor
        tinymce.init({
            selector: '#productDescription',
            height: 400,
            menubar: false,
            plugins: 'lists link image table code wordcount',
            toolbar: 'undo redo | blocks fontfamily | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image | table code',
            images_upload_handler: (blobInfo) => new Promise((resolve, reject) => {
                const fd = new FormData();
                fd.append('file', blobInfo.blob(), blobInfo.filename());
                $.ajax({
                    url: '/v1/api/admin/products/upload-image',
                    type: 'POST', data: fd, processData: false, contentType: false,
                    success: (res) => resolve(res.location),
                    error: () => reject('Upload failed')
                });
            })
        });

        // Submit Form AJAX
        $('#productForm').on('submit', function(e) {
            e.preventDefault();
            tinymce.triggerSave();

            Swal.fire({
                title: 'ƒêANG X·ª¨ L√ù',
                text: 'H·ªá th·ªëng ƒëang l∆∞u tr·ªØ s·∫£n ph·∫©m...',
                showConfirmButton: false, allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const formData = new FormData(this);
            $.ajax({
                url: '/v1/api/admin/products/save',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function() {
                    Swal.fire({
                        icon: 'success',
                        title: 'TH√ÄNH C√îNG',
                        text: 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o kho.',
                        confirmButtonColor: '#000'
                    }).then(() => window.location.href = "/admin/products");
                },
                error: function(xhr) {
                    Swal.fire({ icon: 'error', title: 'TH·∫§T B·∫†I', text: xhr.responseJSON?.message || 'L·ªói l∆∞u d·ªØ li·ªáu' });
                }
            });
        });

        if (variantIndex === 0) addVariantRow();
    });
</script>
</div>