<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">
    <style>
        .tox-tinymce { border: 1px solid #e5e7eb !important; border-radius: 0.75rem !important; overflow: hidden; }
        .variant-item { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
        <form th:action="@{/admin/products/save}" method="post" enctype="multipart/form-data"
              th:object="${productDTO}" id="productForm" class="pb-20">

            <input type="hidden" th:field="*{id}">
            <input type="hidden" th:field="*{thumbnailUrl}">

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl font-black uppercase tracking-tighter text-gray-900"
                        th:text="${isEditMode} ? 'Cập nhật sản phẩm' : 'Đăng sản phẩm mới'"></h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mt-1 italic">TulipShop / Inventory Management</p>
                </div>
                <div class="flex gap-3">
                    <a th:href="@{/admin/products}" class="px-6 py-3 text-[10px] font-black uppercase tracking-widest border border-gray-200 bg-white hover:bg-gray-50 transition-all">Hủy</a>
                    <button type="submit" class="bg-black text-white px-8 py-3 text-[10px] font-black uppercase tracking-[0.2em] hover:bg-gray-800 transition-all shadow-xl active:scale-95">
                        <span th:text="${isEditMode} ? 'Lưu thay đổi' : 'Đăng sản phẩm'"></span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <div class="lg:col-span-8 space-y-6">

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-6 border-b pb-2 flex items-center gap-2">
                            <i data-lucide="info" class="w-3 h-3"></i> Thông tin cơ bản
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">Tên sản phẩm <span class="text-red-500">*</span></label>
                                <input type="text" th:field="*{name}" required
                                       class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm focus:border-black outline-none transition-all placeholder:text-gray-300"
                                       placeholder="Áo sơ mi lụa Tulip Premium...">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">Mô tả sản phẩm</label>
                                <textarea th:field="*{description}" id="productDescription"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <div class="flex gap-8 border-b border-gray-100 mb-6">
                            <button type="button" class="tab-btn active pb-4 text-[10px] font-black uppercase tracking-widest border-b-2 border-black" data-target="#pane-general">Thiết lập giá</button>
                            <button type="button" class="tab-btn pb-4 text-[10px] font-black uppercase tracking-widest text-gray-400 hover:text-black transition-colors" data-target="#pane-variants">Quản lý biến thể & Kho</button>
                        </div>

                        <div class="tab-panes">
                            <div id="pane-general" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">Giá niêm yết (₫)</label>
                                        <div class="relative">
                                            <input type="number" th:field="*{price}" required
                                                   class="w-full border border-gray-200 rounded-lg pl-4 pr-10 py-2.5 text-sm focus:border-black outline-none font-bold">
                                            <span class="absolute right-4 top-2.5 text-gray-400 text-xs font-bold">₫</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-700 mb-2">Giá khuyến mãi (₫)</label>
                                        <div class="relative">
                                            <input type="number" th:field="*{discountPrice}"
                                                   class="w-full border border-gray-200 rounded-lg pl-4 pr-10 py-2.5 text-sm focus:border-black outline-none font-bold text-red-500">
                                            <span class="absolute right-4 top-2.5 text-gray-400 text-xs font-bold">₫</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="pane-variants" class="hidden space-y-4">
                                <div id="variants-container" class="space-y-6">
                                    <div th:each="variant, stat : *{variants}" class="variant-item bg-gray-50 border border-gray-200 rounded-xl p-6 relative group">
                                        <button type="button" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors" onclick="removeVariantRow(this)">
                                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                                        </button>

                                        <input type="hidden" th:name="|variants[${stat.index}].id|" th:value="${variant.id}">

                                        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                                            <div class="md:col-span-4 space-y-4">
                                                <div>
                                                    <label class="text-[9px] font-black text-gray-400 uppercase mb-2 block">Phân loại màu</label>
                                                    <input type="text" placeholder="Tên màu" required
                                                           class="w-full border border-gray-200 rounded px-3 py-2 text-xs font-bold uppercase outline-none focus:border-black"
                                                           th:name="|variants[${stat.index}].colorName|" th:value="${variant.colorName}">
                                                </div>
                                                <div class="flex items-center gap-3">
                                                    <input type="color" class="h-10 w-16 border-none p-0 cursor-pointer bg-transparent"
                                                           th:name="|variants[${stat.index}].colorCode|" th:value="${variant.colorCode}">
                                                    <span class="text-[9px] font-black text-gray-500 uppercase tracking-tighter">Mã màu HEX</span>
                                                </div>
                                                <div>
                                                    <label class="block cursor-pointer bg-white border-2 border-dashed border-gray-200 text-center py-3 text-[10px] font-black uppercase hover:border-black transition-all">
                                                        <i data-lucide="upload-cloud" class="w-4 h-4 mx-auto mb-1"></i> + Upload ảnh màu
                                                        <input type="file" class="hidden variant-file" accept="image/*" multiple onchange="updateFileName(this)" th:name="|variants[${stat.index}].imageFiles|">
                                                    </label>
                                                    <div class="variant-preview-list flex flex-wrap gap-2 mt-3">
                                                        <img th:each="url : ${variant.imageUrls}" th:src="${url}" class="w-12 h-12 object-cover border border-black rounded shadow-sm">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="md:col-span-8">
                                                <label class="text-[9px] font-black text-gray-400 uppercase mb-4 block tracking-widest">Tình trạng kho hàng (Size)</label>
                                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                                    <div th:each="size : ${allSizes}" class="flex flex-col border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                                                        <div class="bg-gray-50 text-[10px] font-black py-1 text-center border-b border-gray-200" th:text="${size.code}"></div>
                                                        <input type="number" class="w-full px-2 py-2 text-center text-sm font-bold outline-none focus:bg-gray-50"
                                                               placeholder="0" min="0"
                                                               th:name="|variants[${stat.index}].stockPerSize['${size.code}']|"
                                                               th:value="${variant.stockPerSize != null ? (variant.stockPerSize.get(size.code) ?: 0) : 0}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addVariantRow()" class="w-full border-2 border-dashed border-gray-200 py-6 text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 hover:border-black hover:text-black transition-all rounded-xl">
                                    + Thêm biến thể sản phẩm mới
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 space-y-6">

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Trạng thái sản phẩm</h2>
                        <select th:field="*{status}" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm font-bold outline-none focus:border-black">
                            <option value="ACTIVE">Hoạt động</option>
                            <option value="HIDDEN">Ẩn</option>
                        </select>
                        <p class="text-[9px] text-gray-400 mt-2 italic">
                            <strong>Hoạt động:</strong> Hiển thị trên website<br>
                            <strong>Ẩn:</strong> Không hiển thị trên website
                        </p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Ảnh đại diện</h2>
                        <div class="relative group cursor-pointer border-2 border-dashed border-gray-200 rounded-xl overflow-hidden aspect-[3/4] flex items-center justify-center bg-gray-50 hover:bg-gray-100 transition-all"
                             onclick="document.getElementById('mainImageInput').click()">

                            <img id="mainImagePreview" class="absolute inset-0 w-full h-full object-contain p-2 hidden" src="#">
                            <img id="currentImage" th:if="${productDTO.thumbnailUrl != null}" th:src="${productDTO.thumbnailUrl}" class="absolute inset-0 w-full h-full object-contain p-2">

                            <div id="mainImagePlaceholder" class="text-center z-10" th:style="${productDTO.thumbnailUrl != null ? 'display: none;' : 'display: block;'}">
                                <i data-lucide="image" class="w-10 h-10 mx-auto text-gray-300 mb-2"></i>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Tải ảnh đại diện</p>
                            </div>
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span class="text-white text-[10px] font-black uppercase">Thay đổi ảnh</span>
                            </div>
                        </div>
                        <input type="file" id="mainImageInput" class="hidden" th:field="*{mainImageFile}" accept="image/*" onchange="previewMainImage(this)">
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Danh mục</h2>
                        <select id="categorySelect" th:field="*{categorySlug}" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm font-bold outline-none focus:border-black appearance-none bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1jaGV2cm9uLWRvd24iPjxwYXRoIGQ9Im02IDkgNiA2IDYtNiIvPjwvc3ZnPg==')] bg-[length:16px_16px] bg-[right_1rem_center] bg-no-repeat">
                            <option value="" disabled selected>-- Chọn danh mục sản phẩm --</option>
                            <option th:each="cat : ${categories}" th:value="${cat.slug}" th:text="${cat.displayName}" th:data-id="${cat.id}"></option>
                        </select>

                        <button type="button" onclick="toggleAddCategory()" class="mt-4 text-[9px] font-black text-gray-400 uppercase hover:text-black tracking-[0.2em] transition-colors">+ Thêm danh mục mới</button>

                        <div id="addCategoryPanel" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-xl space-y-3">
                            <input type="text" id="newCatName" placeholder="Tên danh mục..." class="w-full px-3 py-2 text-xs border border-gray-200 rounded outline-none focus:border-black">
                            <select id="newCatParent" class="w-full px-3 py-2 text-[10px] font-bold border border-gray-200 rounded outline-none">
                                <option value="-1">-- Danh mục gốc --</option>
                            </select>
                            <button type="button" onclick="addNewCategoryAjax()" class="w-full bg-black text-white py-2 text-[10px] font-black uppercase tracking-widest hover:bg-gray-800 transition-all">Xác nhận thêm</button>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-4 border-b pb-2">Nhãn sản phẩm (Tags)</h2>
                        <div id="tag-input-container" class="flex flex-wrap gap-2 border border-gray-200 rounded-lg p-3 min-h-[50px] focus-within:border-black transition-all bg-white">
                            <input type="text" id="tag-input-field" class="outline-none text-xs flex-1 min-w-[80px]" placeholder="Nhập nhãn...">
                        </div>
                        <input type="hidden" th:field="*{tags}" id="hidden-tags-input">
                        <p class="text-[9px] text-gray-400 mt-2 italic italic">Gõ tên tag và nhấn Enter hoặc Dấu phẩy</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<template id="variant-template">
    <div class="variant-item bg-gray-50 border border-gray-200 rounded-xl p-6 relative group">
        <button type="button" class="absolute top-4 right-4 text-gray-300 hover:text-red-500" onclick="removeVariantRow(this)">
            <i data-lucide="x-circle" class="w-5 h-5"></i>
        </button>
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
            <div class="md:col-span-4 space-y-4">
                <div>
                    <label class="text-[9px] font-black text-gray-400 uppercase mb-2 block">Phân loại màu</label>
                    <input type="text" placeholder="Tên màu" required class="w-full border border-gray-200 rounded px-3 py-2 text-xs font-bold uppercase variant-name">
                </div>
                <div class="flex items-center gap-3">
                    <input type="color" class="h-10 w-16 border-none p-0 cursor-pointer bg-transparent variant-color-code" value="#000000">
                    <span class="text-[9px] font-black text-gray-500 uppercase tracking-tighter">Mã màu HEX</span>
                </div>
                <div>
                    <label class="block cursor-pointer bg-white border-2 border-dashed border-gray-200 text-center py-3 text-[10px] font-black uppercase hover:border-black transition-all">
                        + Upload ảnh màu
                        <input type="file" class="hidden variant-file" accept="image/*" multiple onchange="updateFileName(this)">
                    </label>
                    <div class="variant-preview-list flex flex-wrap gap-2 mt-3"></div>
                </div>
            </div>
            <div class="md:col-span-8">
                <label class="text-[9px] font-black text-gray-400 uppercase mb-4 block tracking-widest">Tình trạng kho hàng (Size)</label>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                    <div th:each="size : ${allSizes}" class="flex flex-col border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                        <div class="bg-gray-50 text-[10px] font-black py-1 text-center border-b border-gray-200" th:text="${size.code}"></div>
                        <input type="number" class="w-full px-2 py-2 text-center text-sm font-bold outline-none variant-stock"
                               placeholder="0" min="0" th:data-size-code="${size.code}">
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.tiny.cloud/1/we6asp3e5hwysfsm9y5hbkwdh260fckl3vk4g2p38g97axz3/tinymce/7/tinymce.min.js"></script>

<script th:inline="javascript">
    /* Biến từ Thymeleaf */
    let variantIndex = /*[[${productDTO.variants != null ? productDTO.variants.size() : 0}]]*/ 0;
    let tags = [];

    // --- 1. TABS LOGIC ---
    $('.tab-btn').click(function() {
        const target = $(this).data('target');
        $('.tab-btn').removeClass('active border-black text-black').addClass('text-gray-400');
        $(this).addClass('active border-black text-black').removeClass('text-gray-400');
        $('#pane-general, #pane-variants').addClass('hidden');
        $(target).removeClass('hidden');
    });

    // --- 2. ẢNH ĐẠI DIỆN ---
    function previewMainImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                $('#mainImagePreview').attr('src', e.target.result).fadeIn().removeClass('hidden');
                $('#currentImage, #mainImagePlaceholder').fadeOut().addClass('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 3. BIẾN THỂ (VARIANTS) ---
    function addVariantRow() {
        const container = document.getElementById('variants-container');
        const template = document.getElementById('variant-template');
        const clone = template.content.cloneNode(true);
        const div = clone.querySelector('.variant-item');

        div.querySelector('.variant-name').name = `variants[${variantIndex}].colorName`;
        div.querySelector('.variant-color-code').name = `variants[${variantIndex}].colorCode`;
        div.querySelector('.variant-file').name = `variants[${variantIndex}].imageFiles`;

        div.querySelectorAll('.variant-stock').forEach(input => {
            const sc = input.getAttribute('data-size-code');
            input.name = `variants[${variantIndex}].stockPerSize['${sc}']`;
            input.value = 0;
        });

        container.appendChild(div);
        variantIndex++;
        lucide.createIcons();
    }

    function removeVariantRow(btn) {
        $(btn).closest('.variant-item').fadeOut(300, function() { $(this).remove(); });
    }

    function updateFileName(input) {
        const preview = input.parentElement.nextElementSibling;
        preview.innerHTML = '';
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = `<img src="${e.target.result}" class="w-12 h-12 object-cover border border-black rounded shadow-sm">`;
                preview.innerHTML += img;
            }
            reader.readAsDataURL(file);
        });
    }

    // --- 4. DANH MỤC AJAX ---
    function toggleAddCategory() {
        const panel = $('#addCategoryPanel');
        if (panel.is(':hidden')) {
            const options = $('#categorySelect option').clone();
            $('#newCatParent').empty().append('<option value="-1">-- Danh mục gốc --</option>');
            options.each(function() {
                if($(this).val()) $('#newCatParent').append($(this));
            });
            panel.slideDown();
        } else { panel.slideUp(); }
    }

    function addNewCategoryAjax() {
        const name = $('#newCatName').val();
        const parentId = $('#newCatParent').find(':selected').data('id') || -1;
        if (!name) { alert('Vui lòng nhập tên danh mục'); return; }

        $.ajax({
            url: '/v1/api/admin/products/quick-add-category',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name, parentId: parentId }),
            success: function(res) {
                const newOpt = `<option value="${res.category.slug}" data-id="${res.category.id}" selected>${res.category.displayName}</option>`;
                $('#categorySelect').append(newOpt);
                $('#newCatName').val('');
                $('#addCategoryPanel').slideUp();
            }
        });
    }

    // --- 5. TAGS LOGIC ---
    function renderTags() {
        const container = $('#tag-input-container');
        container.find('.tag-badge').remove();
        tags.forEach(t => {
            const html = `<span class="tag-badge bg-black text-white text-[9px] font-black uppercase tracking-widest px-2 py-1.5 rounded flex items-center gap-2">
                    ${t} <button type="button" onclick="removeTag('${t}')" class="hover:text-red-400">×</button>
                </span>`;
            $('#tag-input-field').before(html);
        });
        $('#hidden-tags-input').val(tags.join(','));
    }

    function removeTag(t) { tags = tags.filter(tag => tag !== t); renderTags(); }

    // --- 6. TINYMCE & SUBMIT ---
    $(document).ready(function() {
        // Init Tags
        const curTags = $('#hidden-tags-input').val();
        if (curTags) { tags = curTags.split(',').filter(x => x.trim()!==''); renderTags(); }

        $('#tag-input-field').on('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const v = $(this).val().trim();
                if (v && !tags.includes(v)) { tags.push(v); renderTags(); }
                $(this).val('');
            }
        });

        // TinyMCE Editor
        tinymce.init({
            selector: '#productDescription',
            height: 400,
            menubar: false,
            plugins: 'lists link image table code wordcount',
            toolbar: 'undo redo | blocks fontfamily | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image | table code',
            images_upload_handler: (blobInfo) => new Promise((resolve, reject) => {
                const fd = new FormData();
                fd.append('file', blobInfo.blob(), blobInfo.filename());
                $.ajax({
                    url: '/v1/api/admin/products/upload-image',
                    type: 'POST', data: fd, processData: false, contentType: false,
                    success: (res) => resolve(res.location),
                    error: () => reject('Upload failed')
                });
            })
        });

        // Submit Form AJAX
        $('#productForm').on('submit', function(e) {
            e.preventDefault();
            tinymce.triggerSave();

            Swal.fire({
                title: 'ĐANG XỬ LÝ',
                text: 'Hệ thống đang lưu trữ sản phẩm...',
                showConfirmButton: false, allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const formData = new FormData(this);
            $.ajax({
                url: '/v1/api/admin/products/save',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function() {
                    Swal.fire({
                        icon: 'success',
                        title: 'THÀNH CÔNG',
                        text: 'Sản phẩm đã được cập nhật vào kho.',
                        confirmButtonColor: '#000'
                    }).then(() => window.location.href = "/admin/products");
                },
                error: function(xhr) {
                    Swal.fire({ icon: 'error', title: 'THẤT BẠI', text: xhr.responseJSON?.message || 'Lỗi lưu dữ liệu' });
                }
            });
        });

        if (variantIndex === 0) addVariantRow();
    });
</script>
</div>