<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" th:href="@{/css/inventory.css}">
    <link rel="stylesheet" th:href="@{/css/notification.css}">
    <style>
        /* Tree View Styles */
        .category-tree {
            list-style: none;
            padding-left: 0;
        }
        
        .category-tree ul {
            list-style: none;
            padding-left: 30px;
            margin-top: 8px;
        }
        
        .category-node {
            margin-bottom: 8px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s;
            gap: 12px;
        }
        
        .category-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .category-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .category-toggle:hover {
            background: #e5e7eb;
        }
        
        .category-toggle.collapsed i {
            transform: rotate(-90deg);
        }
        
        .category-toggle i {
            transition: transform 0.2s;
        }
        
        .category-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 6px;
            flex-shrink: 0;
        }
        
        .category-icon.has-children {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .category-icon.no-children {
            background: #fef3c7;
            color: #d97706;
        }
        
        .category-info {
            flex: 1;
            min-width: 0;
        }
        
        .category-name {
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #111827;
        }
        
        .category-meta {
            display: flex;
            gap: 12px;
            margin-top: 4px;
            font-size: 11px;
            color: #6b7280;
        }
        
        .category-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .category-actions button {
            padding: 6px 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .btn-add {
            background: #10b981;
            color: white;
        }
        
        .btn-add:hover {
            background: #059669;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .category-children {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .category-children.collapsed {
            max-height: 0 !important;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .status-has-products {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-empty {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        /* Warning Modal Styles */
        .warning-modal .modal-content {
            max-width: 600px;
        }
        
        .product-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            background: #f9fafb;
        }
        
        .product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .product-item:last-child {
            margin-bottom: 0;
        }
        
        .product-thumbnail {
            width: 48px;
            height: 64px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-weight: 600;
            font-size: 13px;
            color: #111827;
        }
        
        .product-status {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
    </style>
</head>
<body>

<div th:fragment="content">
    <div class="space-y-6">
        <!-- Page Header -->
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-black italic tracking-tighter mb-2">Quản lý danh mục</h1>
                <p class="text-sm text-gray-500 uppercase tracking-widest">Category Management</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleAllCategories()" 
                        class="flex items-center gap-2 border border-gray-300 px-4 py-2 text-sm font-bold uppercase tracking-wider hover:bg-gray-50 transition-all">
                    <i data-lucide="chevrons-down" class="w-4 h-4"></i>
                    <span id="toggle-all-text">Thu gọn tất cả</span>
                </button>
                <button onclick="openCategoryModal()" 
                        class="flex items-center gap-2 border border-black px-4 py-2 text-sm font-bold uppercase tracking-wider bg-black text-white hover:bg-gray-800 transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Thêm danh mục gốc</span>
                </button>
            </div>
        </div>

        <!-- Search Control -->
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input type="text" 
                               id="search-input" 
                               placeholder="Tìm theo tên danh mục..."
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-black"
                               onkeyup="handleSearch()">
                    </div>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 uppercase tracking-wider">
                <span id="visible-count">0</span> / <span id="total-count">0</span> danh mục
            </div>
        </div>

        <!-- Category Tree -->
        <div class="bg-white border border-gray-200 rounded-lg p-6">
            <ul id="category-tree" class="category-tree">
                <!-- Loading state -->
                <li class="text-center py-20">
                    <div class="w-8 h-8 border-4 border-indigo-600/20 border-t-indigo-600 rounded-full animate-spin mx-auto"></div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Category Modal (Add/Edit) -->
    <div id="category-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="modal-title">Thêm danh mục mới</h3>
                    <p class="modal-subtitle">Nhập thông tin danh mục</p>
                </div>
                <button onclick="closeCategoryModal()" class="modal-close">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="category-form" class="space-y-4">
                    <input type="hidden" id="category-id">
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            Tên danh mục <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               id="category-name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-black"
                               placeholder="Ví dụ: Áo dài, Váy đầm..."
                               required>
                    </div>
                    
                    <div id="parent-selector-container">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            Danh mục cha
                        </label>
                        <select id="category-parent" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-black">
                            <option value="">-- Không có (Danh mục gốc) --</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Để trống nếu đây là danh mục cấp cao nhất</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeCategoryModal()" 
                        class="px-6 py-2.5 text-sm font-bold uppercase tracking-wider border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                    Hủy
                </button>
                <button onclick="submitCategory()" 
                        class="px-6 py-2.5 text-sm font-bold uppercase tracking-wider bg-black text-white rounded-lg hover:bg-gray-800 transition-all">
                    Lưu
                </button>
            </div>
        </div>
    </div>

    <!-- Warning Modal (Products exist) -->
    <div id="warning-modal" class="modal-overlay hidden warning-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title text-red-600">
                        <i data-lucide="alert-triangle" class="w-5 h-5 inline"></i>
                        Không thể xóa danh mục
                    </h3>
                    <p class="modal-subtitle" id="warning-subtitle"></p>
                </div>
                <button onclick="closeWarningModal()" class="modal-close">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800">
                        <strong>Lưu ý:</strong> Danh mục này đang chứa <strong id="product-count">0</strong> sản phẩm. 
                        Bạn cần xóa mềm (Soft Delete) hoặc chuyển các sản phẩm này sang danh mục khác trước khi xóa danh mục.
                    </p>
                </div>
                
                <h4 class="text-sm font-bold text-gray-700 mb-3">Danh sách sản phẩm:</h4>
                <div id="product-list" class="product-list">
                    <!-- Products will be listed here -->
                </div>
                
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i data-lucide="info" class="w-4 h-4 inline"></i>
                        <strong>Hướng dẫn:</strong> Truy cập trang 
                        <a href="/admin/products" class="underline font-bold">Quản lý sản phẩm</a> 
                        để xóa mềm hoặc chuyển danh mục cho các sản phẩm này.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeWarningModal()" 
                        class="px-6 py-2.5 text-sm font-bold uppercase tracking-wider bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all">
                    Đã hiểu
                </button>
                <a href="/admin/products" 
                   class="px-6 py-2.5 text-sm font-bold uppercase tracking-wider bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all inline-block">
                    Đi đến Quản lý sản phẩm
                </a>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be inserted here -->
    </div>

    <!-- Load JavaScript -->
    <script th:src="@{/js/toast-notification.js}"></script>
    <script th:src="@{/js/admin/category-manager.js}"></script>
    <script>
        // Initialize icons after page load
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</div>

</body>
</html>
