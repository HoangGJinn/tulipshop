<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head(title='Đơn hàng của tôi - Tulip Shop')}">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<!-- Custom CSS cho trang orders -->
<style>
    .orders-page {
        background-color: #f8f9fa;
        min-height: 70vh;
        padding: 40px 0;
    }
    .order-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .order-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .order-body {
        padding: 20px;
    }
    .order-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .order-item:last-child {
        border-bottom: none;
    }
    .order-item-img {
        width: 80px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
    }
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-confirmed { background-color: #d1ecf1; color: #0c5460; }
    .status-shipping { background-color: #cce5ff; color: #004085; }
    .status-delivered { background-color: #d4edda; color: #155724; }
    .status-cancelled { background-color: #f8d7da; color: #721c24; }
    .status-expired { background-color: #f8d7da; color: #721c24; }
    .status-returned { background-color: #e2e3e5; color: #383d41; }
    .payment-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    .payment-success { background-color: #d4edda; color: #155724; }
    .payment-pending { background-color: #fff3cd; color: #856404; }
    .payment-failed { background-color: #f8d7da; color: #721c24; }
    .empty-orders {
        text-align: center;
        padding: 60px 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .empty-orders i {
        font-size: 64px;
        color: #ddd;
        margin-bottom: 20px;
    }
</style>

<div class="orders-page">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-uppercase mb-0">Đơn hàng của tôi</h2>
            <a th:href="@{/products}" class="btn btn-outline-dark">
                <i class="fas fa-shopping-bag me-2"></i>Tiếp tục mua sắm
            </a>
        </div>

        <!-- Filter Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == 'ALL' ? 'active' : ''}" 
                   th:href="@{/orders(status='ALL')}">
                    <i class="fas fa-list me-1"></i>Tất cả
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == 'PENDING' ? 'active' : ''}" 
                   th:href="@{/orders(status='PENDING')}">
                    <i class="fas fa-clock me-1"></i>Chờ xác nhận
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == 'CONFIRMED' ? 'active' : ''}" 
                   th:href="@{/orders(status='CONFIRMED')}">
                    <i class="fas fa-check-circle me-1"></i>Đã xác nhận
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == 'SHIPPING' ? 'active' : ''}" 
                   th:href="@{/orders(status='SHIPPING')}">
                    <i class="fas fa-shipping-fast me-1"></i>Đang giao
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == 'DELIVERED' ? 'active' : ''}" 
                   th:href="@{/orders(status='DELIVERED')}">
                    <i class="fas fa-box-open me-1"></i>Đã giao
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == 'CANCELLED' ? 'active' : ''}" 
                   th:href="@{/orders(status='CANCELLED')}">
                    <i class="fas fa-times-circle me-1"></i>Đã hủy
                </a>
            </li>
        </ul>

        <div th:if="${#lists.isEmpty(orders)}" class="empty-orders">
            <i class="fas fa-shopping-bag"></i>
            <h4 class="mb-3">Bạn chưa có đơn hàng nào</h4>
            <p class="text-muted mb-4">Hãy khám phá các sản phẩm tuyệt vời của chúng tôi!</p>
            <a th:href="@{/products}" class="btn btn-dark">Mua sắm ngay</a>
        </div>

        <div th:unless="${#lists.isEmpty(orders)}">
            <div th:each="order : ${orders}" class="order-card" th:onclick="'window.location.href=\'/orders/' + ${order.id} + '\''">
                <div class="order-header">
                    <div>
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <span class="fw-bold">Mã đơn hàng: 
                                <span th:text="${order.orderCode != null ? order.orderCode : '#' + order.id}"></span>
                            </span>
                            <span th:classappend="'status-badge status-' + ${#strings.toLowerCase(order.status.toString())}"
                                  th:text="${#strings.toUpperCase(order.status.toString())}">
                                PENDING
                            </span>
                        </div>
                        <div class="small text-muted">
                            <i class="far fa-calendar me-1"></i>
                            <span th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2025 10:00</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold fs-5 mb-1" th:text="${#numbers.formatDecimal(order.finalPrice, 0, 'COMMA', 0, 'POINT') + '₫'}">
                            0₫
                        </div>
                        <div class="small text-muted">
                            <span th:classappend="'payment-badge payment-' + ${#strings.toLowerCase(order.paymentStatus.toString())}">
                                <span th:if="${order.paymentStatus.toString() == 'SUCCESS'}">Đã thanh toán</span>
                                <span th:if="${order.paymentStatus.toString() == 'PENDING'}">Chờ thanh toán</span>
                                <span th:if="${order.paymentStatus.toString() == 'EXPIRED'}">Hết hạn thanh toán</span>
                                <span th:if="${order.paymentStatus.toString() == 'FAILED'}">Thanh toán thất bại</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="order-body">
                    <div th:each="item : ${order.orderItems}" class="order-item">
                        <!-- Ưu tiên hiển thị ảnh snapshot -->
                        <img th:if="${item.snapThumbnailUrl != null}"
                             th:src="${item.snapThumbnailUrl}"
                             class="order-item-img"
                             alt="Sản phẩm"
                             onerror="this.src='/images/placeholder.jpg'">
                        <img th:if="${item.snapThumbnailUrl == null and item.variant != null and not #lists.isEmpty(item.variant.images)}"
                             th:src="${item.variant.images[0].imageUrl}"
                             class="order-item-img"
                             alt="Sản phẩm"
                             th:onerror="this.src=(${item.product != null and item.product.thumbnail != null ? item.product.thumbnail : '/images/placeholder.jpg'});">
                        <img th:if="${item.snapThumbnailUrl == null and (item.variant == null or #lists.isEmpty(item.variant.images))}"
                             th:src="${item.product != null and item.product.thumbnail != null ? item.product.thumbnail : '/images/placeholder.jpg'}"
                             class="order-item-img"
                             alt="Sản phẩm">
                        <div class="flex-grow-1">
                            <!-- Hiển thị tên snapshot nếu có -->
                            <div class="fw-bold mb-1" th:text="${item.snapProductName != null ? item.snapProductName : (item.product != null ? item.product.name : 'Sản phẩm đã bị xóa')}">
                                Tên sản phẩm
                            </div>
                            <div class="small text-muted">
                                <span th:if="${item.variant != null}" th:text="'Màu: ' + ${item.variant.colorName}">Màu: Đỏ</span>
                                <span th:if="${item.size != null}" th:text="' | Size: ' + ${item.size.code}"> | Size: M</span>
                                <span th:text="' | SL: ' + ${item.quantity}"> | SL: 1</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <!-- Hiển thị giá snapshot nếu có -->
                            <div class="fw-bold" th:text="${#numbers.formatDecimal(item.snapPrice != null ? item.snapPrice : item.priceAtPurchase, 0, 'COMMA', 0, 'POINT') + '₫'}">
                                0₫
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="small">
                                <div class="text-muted mb-1">
                                    <i class="fas fa-credit-card me-1"></i>
                                    <span th:if="${order.paymentMethod.toString() == 'COD'}">Thanh toán khi nhận hàng (COD)</span>
                                    <span th:if="${order.paymentMethod.toString() == 'VNPAY'}">Thanh toán qua VNPAY</span>
                                    <span th:if="${order.paymentMethod.toString() == 'MOMO'}">Thanh toán qua MOMO</span>
                                </div>
                                <div class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    <span th:text="${order.recipientName + ' - ' + order.recipientPhone}">Người nhận</span>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <!-- Nút xem chi tiết -->
                                <a th:href="@{/orders/{id}(id=${order.id})}" 
                                   class="btn btn-outline-dark btn-sm"
                                   th:onclick="'event.stopPropagation();'">
                                    Xem chi tiết <i class="fas fa-chevron-right ms-1"></i>
                                </a>
                                
                                <!-- Nút mua lại cho đơn đã hoàn thành -->
                                <form th:if="${order.status.toString() == 'DELIVERED'}" 
                                      th:action="@{/orders/{orderId}/re-order(orderId=${order.id})}" 
                                      method="post" 
                                      th:onclick="'event.stopPropagation();'"
                                      style="display: inline-block;">
                                    <button type="submit" class="btn btn-success btn-sm" title="Mua lại đơn hàng này">
                                        <i class="fas fa-redo-alt me-1"></i>Mua lại
                                    </button>
                                </form>
                                
                                <!-- Nút mua lại cho đơn đã hủy/hết hạn -->
                                <form th:if="${order.status.toString() == 'CANCELLED' and order.paymentStatus.toString() == 'EXPIRED'}" 
                                      th:action="@{/orders/{orderId}/re-order(orderId=${order.id})}" 
                                      method="post" 
                                      th:onclick="'event.stopPropagation();'"
                                      style="display: inline-block;">
                                    <button type="submit" class="btn btn-success btn-sm" title="Mua lại đơn hàng này">
                                        <i class="fas fa-redo-alt me-1"></i>Mua lại
                                    </button>
                                </form>
                                
                                <!-- Nút thanh toán cho đơn chưa thanh toán -->
                                <a th:if="${order.status.toString() == 'PENDING' 
                                            and order.paymentStatus.toString() == 'PENDING' 
                                            and order.paymentUrl != null 
                                            and order.paymentExpireAt != null 
                                            and order.paymentExpireAt.isAfter(T(java.time.LocalDateTime).now())}"
                                   th:href="${order.paymentUrl}" 
                                   class="btn btn-primary btn-sm"
                                   th:onclick="'event.stopPropagation();'"
                                   title="Tiếp tục thanh toán">
                                    <i class="fas fa-credit-card me-1"></i>Thanh toán
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html>
