<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head('Thông tin tài khoản - Tulip Shop')}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container my-5">
    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- Left Column: Profile Information -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-user-circle"></i> Thông tin tài khoản</h4>
                    <button type="button" class="btn btn-light btn-sm" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Chỉnh sửa
                    </button>
                </div>
                <div class="card-body">
                    <!-- Avatar Section -->
                    <div class="text-center mb-4">
                        <div class="avatar-container" style="position: relative; display: inline-block;">
                            <img th:src="${profile.avatar != null ? profile.avatar : 'https://via.placeholder.com/150'}"
                                 alt="Avatar"
                                 class="rounded-circle"
                                 style="width: 150px; height: 150px; object-fit: cover; border: 4px solid #f0f0f0;"
                                 id="avatar-preview">
                            <label for="avatar-input"
                                   id="avatar-upload-label"
                                   style="position: absolute; bottom: 0; right: 0; background: #000; color: #fff; border-radius: 50%; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; cursor: pointer; transition: background 0.3s;"
                                   onmouseover="this.style.background='#333'"
                                   onmouseout="this.style.background='#000'">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file"
                                   id="avatar-input"
                                   name="avatarFile"
                                   accept="image/*"
                                   style="display: none;"
                                   disabled>
                        </div>
                    </div>

                    <!-- Profile Form -->
                    <form th:action="@{/account}"
                          th:object="${form}"
                          method="post"
                          enctype="multipart/form-data"
                          id="profileForm">

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email"
                                   class="form-control"
                                   id="email"
                                   th:field="*{email}"
                                   readonly
                                   style="background-color: #f5f5f5;">
                            <small class="text-muted">Email không thể thay đổi</small>
                        </div>

                        <div class="mb-3">
                            <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text"
                                   class="form-control"
                                   id="fullName"
                                   th:field="*{fullName}"
                                   placeholder="Nhập họ và tên"
                                   readonly
                                   style="background-color: #f5f5f5;"
                                   required>
                            <div th:if="${#fields.hasErrors('fullName')}"
                                 class="text-danger small mt-1"
                                 th:errors="*{fullName}"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Số điện thoại</label>
                                <input type="tel"
                                       class="form-control"
                                       id="phone"
                                       th:field="*{phone}"
                                       placeholder="0123456789"
                                       readonly
                                       style="background-color: #f5f5f5;">
                                <div th:if="${#fields.hasErrors('phone')}"
                                     class="text-danger small mt-1"
                                     th:errors="*{phone}"></div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">Giới tính</label>
                                <select class="form-select"
                                        id="gender"
                                        th:field="*{gender}"
                                        disabled
                                        style="background-color: #f5f5f5;">
                                    <option value="">Chọn giới tính</option>
                                    <option value="0">Nữ</option>
                                    <option value="1">Nam</option>
                                    <option value="2">Khác</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="birthday" class="form-label">Ngày sinh</label>
                            <input type="date"
                                   class="form-control"
                                   id="birthday"
                                   th:field="*{birthday}"
                                   readonly
                                   style="background-color: #f5f5f5;">
                        </div>

                        <div class="d-flex justify-content-end gap-2" id="formActions" style="display: none;">
                            <button type="button" class="btn btn-secondary" id="cancelEditBtn">
                                <i class="fas fa-times"></i> Hủy
                            </button>
                            <button type="submit" class="btn btn-dark btn-secondary" id="saveProfileBtn">
                                <i class="fas fa-save"></i> Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Address Section -->
        <div th:replace="~{fragments/address-section :: address-section}"></div>
    </div>
</div>

<!-- Address Modal -->
<div th:replace="~{fragments/address-modal :: address-modal}"></div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script th:replace="~{fragments/header :: header-scripts}"></script>
<script th:src="@{/js/address-api.js}"></script>
<script th:replace="~{fragments/address-section :: address-scripts}"></script>

<script>
    $(document).ready(function() {
        // Profile Edit Mode Toggle
        let isEditMode = false;
        let originalFormData = {};

        // Initialize: Ensure form is in view mode on page load
        $('#formActions').attr('style', 'display: none !important;');
        $('#editProfileBtn').show();
        $('#avatar-upload-label').hide();

        function enableEditMode() {
            isEditMode = true;
            
            // Save original values
            originalFormData = {
                fullName: $('#fullName').val(),
                phone: $('#phone').val(),
                gender: $('#gender').val(),
                birthday: $('#birthday').val()
            };

            // Enable inputs
            $('#fullName').prop('readonly', false).css('background-color', '#fff');
            $('#phone').prop('readonly', false).css('background-color', '#fff');
            $('#gender').prop('disabled', false).css('background-color', '#fff');
            $('#birthday').prop('readonly', false).css('background-color', '#fff');
            $('#avatar-input').prop('disabled', false);
            
            // Show avatar upload button
            $('#avatar-upload-label').css('display', 'flex');
            
            // Hide edit button, show save/cancel buttons
            $('#editProfileBtn').hide();
            $('#formActions').attr('style', 'display: flex !important;');
        }

        function disableEditMode() {
            isEditMode = false;
            
            // Restore original values
            $('#fullName').val(originalFormData.fullName);
            $('#phone').val(originalFormData.phone);
            $('#gender').val(originalFormData.gender);
            $('#birthday').val(originalFormData.birthday);
            
            // Disable inputs
            $('#fullName').prop('readonly', true).css('background-color', '#f5f5f5');
            $('#phone').prop('readonly', true).css('background-color', '#f5f5f5');
            $('#gender').prop('disabled', true).css('background-color', '#f5f5f5');
            $('#birthday').prop('readonly', true).css('background-color', '#f5f5f5');
            $('#avatar-input').prop('disabled', true);
            
            // Hide avatar upload button
            $('#avatar-upload-label').hide();
            
            // Show edit button, hide save/cancel buttons
            $('#editProfileBtn').show();
            $('#formActions').attr('style', 'display: none !important;');
            
            // Reset avatar input
            $('#avatar-input').val('');
        }

        // Edit button click
        $('#editProfileBtn').on('click', function() {
            enableEditMode();
        });

        // Cancel button click
        $('#cancelEditBtn').on('click', function() {
            disableEditMode();
        });

        // Avatar preview
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');

        if (avatarInput && avatarPreview) {
            avatarInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Vui lòng chọn file ảnh!');
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Kích thước ảnh không được vượt quá 5MB!');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }); // End of Profile Edit Mode $(document).ready()
</script>
</body>
</html>