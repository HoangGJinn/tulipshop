<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - Tulip Shop</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <style>
        /* CSS riêng cho trang cart */
        .cart-page { background-color: #f8f9fa; min-height: 60vh; }
        .cart-item-img { width: 80px; height: 100px; object-fit: cover; border-radius: 4px; }
        .cart-summary { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn-checkout { background-color: #000; color: #fff; width: 100%; padding: 12px; font-weight: 600; text-transform: uppercase; border: none; }
        .btn-checkout:hover { background-color: #333; color: #fff; }
        .quantity-input { max-width: 60px; text-align: center; border: 1px solid #ddd; }
        .trash-icon { color: #999; cursor: pointer; transition: 0.2s; }
        .trash-icon:hover { color: #dc3545; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="cart-page py-5">
    <div class="container">
        <h2 class="fw-bold mb-4 text-uppercase">Giỏ hàng của bạn</h2>

        <div th:if="${#lists.isEmpty(cartItems)}" class="text-center py-5 bg-white rounded shadow-sm">
            <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
            <p class="fs-5 text-muted">Giỏ hàng của bạn đang trống</p>
            <a href="/products" class="btn btn-dark mt-2">Tiếp tục mua sắm</a>
        </div>

        <div th:unless="${#lists.isEmpty(cartItems)}" class="row">
            <div class="col-lg-8 mb-4">
                <div class="bg-white rounded shadow-sm overflow-hidden">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3">Sản phẩm</th>
                                <th class="py-3">Đơn giá</th>
                                <th class="py-3 text-center">Số lượng</th>
                                <th class="py-3 text-end">Thành tiền</th>
                                <th class="py-3 text-end pe-4"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${cartItems}">
                                <td class="ps-4 py-3">
                                    <div class="d-flex align-items-center">
                                        <a th:href="@{/product/{id}(id=${item.productId})}">
                                            <img th:src="${item.productImage}" class="cart-item-img border" alt="Sản phẩm">
                                        </a>
                                        <div class="ms-3">
                                            <a th:href="@{/product/{id}(id=${item.productId})}"
                                               class="text-decoration-none text-dark fw-bold d-block mb-1"
                                               th:text="${item.productName}">Tên sản phẩm</a>
                                            <div class="small text-muted">
                                                Màu: <span th:text="${item.colorName}"></span> |
                                                Size: <span th:text="${item.sizeCode}"></span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-bold text-secondary">
                                    <span th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + '₫'"></span>
                                </td>
                                <td class="text-center">
                                    <input type="number"
                                           class="form-control form-control-sm quantity-input d-inline-block"
                                           th:value="${item.quantity}"
                                           min="1"
                                           th:onchange="'updateQuantity(' + ${item.id} + ', this.value)'">
                                </td>
                                <td class="text-end fw-bold">
                                    <span th:text="${#numbers.formatDecimal(item.subTotal, 0, 'COMMA', 0, 'POINT')} + '₫'"></span>
                                </td>
                                <td class="text-end pe-4">
                                    <i class="fas fa-trash-alt trash-icon"
                                       th:onclick="'removeItem(' + ${item.id} + ')'"
                                       title="Xóa sản phẩm"></i>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="cart-summary sticky-top" style="top: 100px;">
                    <h5 class="fw-bold mb-3">Tóm tắt đơn hàng</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Tạm tính</span>
                        <span class="fw-bold" th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + '₫'"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 border-bottom pb-3">
                        <span class="text-muted">Phí vận chuyển</span>
                        <span class="text-success small">Miễn phí</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold fs-5">Tổng cộng</span>
                        <span class="fw-bold fs-5 text-danger" th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + '₫'"></span>
                    </div>

                    <a href="/checkout" class="btn btn-checkout rounded-0">
                        Thanh toán ngay
                    </a>
                    <div class="text-center mt-3">
                        <a href="/products" class="text-decoration-none small text-muted">
                            <i class="fas fa-arrow-left me-1"></i> Tiếp tục mua sắm
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // Hàm cập nhật số lượng
    function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
            alert("Số lượng phải lớn hơn 0");
            location.reload();
            return;
        }

        // Gọi API: POST /api/cart/update (đã định nghĩa trong CartController)
        const formData = new FormData();
        formData.append('itemId', itemId);
        formData.append('quantity', newQuantity);

        fetch('/api/cart/update', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Tải lại trang để cập nhật giá tiền
                } else {
                    return response.text().then(text => { throw new Error(text) });
                }
            })
            .catch(error => {
                alert('Lỗi: ' + error.message);
                location.reload();
            });
    }

    // Hàm xóa sản phẩm
    function removeItem(itemId) {
        if (!confirm('Bạn chắc chắn muốn xóa sản phẩm này?')) return;

        // Gọi API: DELETE /api/cart/remove/{itemId}
        fetch(`/api/cart/remove/${itemId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Tải lại trang sau khi xóa
                } else {
                    alert('Có lỗi xảy ra khi xóa sản phẩm.');
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>

</body>
</html>