<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title=${product.name})}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<link rel="stylesheet" th:href="@{/css/product-detail.css}">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

<div class="container py-4 product-page">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb small text-uppercase">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="/products" class="text-decoration-none text-muted">TỔNG SẢN PHẨM</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${product.name}">Tên sản phẩm</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-1 d-none d-md-block">
            <div class="d-flex flex-column gap-2 thumbnail-list"
                 th:if="${not #lists.isEmpty(product.variants) and not #lists.isEmpty(product.variants[0].images)}">
                <img th:each="img, iter : ${product.variants[0].images}"
                     th:src="${img}"
                     class="img-fluid thumbnail-img"
                     th:classappend="${iter.index == 0} ? 'active-thumb'"
                     onclick="changeMainImage(this)">
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="main-image-container">
                <img id="mainImage" class="img-fluid w-100"
                     th:if="${not #lists.isEmpty(product.variants) and not #lists.isEmpty(product.variants[0].images)}"
                     th:src="${product.variants[0].images[0]}"
                     alt="Product Image">

            </div>
        </div>

        <div class="col-md-5 ps-md-4">
            <h1 class="product-title" th:text="${product.name}">Tên sản phẩm</h1>

            <div class="text-muted small mb-3 d-flex align-items-center gap-2">
                <span>SKU: <span class="fw-bold" th:text="${product.sku != null ? product.sku : '#' + product.id}"></span></span>
                <span class="text-muted">|</span>
                <span>Hiện lại còn <span id="stockCount" class="fw-bold">--</span> sản phẩm</span>
            </div>

            <div class="price-tag mb-4">
                <span th:text="${#numbers.formatDecimal(product.basePrice, 0, 'COMMA', 0, 'POINT') + '₫'}">0₫</span>
            </div>

            <div class="mb-4">
                <button class="btn btn-link p-0 text-decoration-none text-dark wishlist-btn" onclick="toggleWishlist(this)">
                    <i class="far fa-heart fs-5"></i>
                    <span class="ms-2 small text-uppercase border-bottom border-dark">Thêm vào yêu thích</span>
                </button>
            </div>

            <div class="mb-4">
                <label class="fw-bold mb-2 small text-uppercase d-block">CHỌN MÀU</label>
                <div class="d-flex gap-2">
                    <div th:each="variant, iter : ${product.variants}"
                         class="color-swatch"
                         th:classappend="${iter.index == 0} ? 'active'"
                         th:data-index="${iter.index}"
                         th:title="${variant.colorName}"
                         onclick="selectColor(this)">
                        <img th:if="${not #lists.isEmpty(product.variants)}" th:src="${variant.images[0]}" class="img-cover">
                        <span class="color-name-overlay" th:text="${variant.colorName}">Màu</span>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="fw-bold small text-uppercase">KÍCH THƯỚC</label>
                    <a href="#" class="text-warning small text-decoration-none">Bảng size ></a>
                </div>
                <div class="d-flex gap-2">
                    <button th:each="size : ${product.allSizes}"
                            type="button"
                            class="btn btn-size"
                            th:text="${size}"
                            th:data-size="${size}"
                            onclick="selectSize(this)">
                        S
                    </button>
                </div>
                <div id="stockMessage" class="mt-2 small text-danger fst-italic" style="display: none;"></div>
            </div>

            <div class="mb-4 d-flex align-items-center">
                <label class="fw-bold me-3 small text-uppercase mb-0">SỐ LƯỢNG:</label>
                <div class="input-group quantity-group input-group-sm">
                    <button class="btn btn-light border" onclick="updateQuantity(-1)">-</button>
                    <input type="number" class="form-control text-center border-start-0 border-end-0 p-0" id="quantity" value="1" min="1">
                    <button class="btn btn-light border" onclick="updateQuantity(1)">+</button>
                </div>
            </div>

            <div class="d-flex gap-3 mb-5">
                <button id="addToCartBtn" class="btn btn-outline-dark flex-grow-1 py-3 text-uppercase fw-bold rounded-0" onclick="addToCart()">
                    THÊM VÀO GIỎ
                </button>
                <button class="btn btn-danger-custom flex-grow-1 py-3 text-uppercase fw-bold rounded-0">
                    MUA NGAY
                </button>
            </div>

            <div class="product-details-container">
                <details class="detail-bar">
                    <summary class="d-flex justify-content-between align-items-center py-3 border-top border-bottom cursor-pointer">
                        <span class="text-uppercase fw-bold small">CHI TIẾT SẢN PHẨM</span>
                        <i class="fas fa-plus small"></i>
                    </summary>
                    <div class="py-3 text-secondary small detail-content">
                        <div th:utext="${product.description}">Nội dung mô tả sản phẩm...</div>

                        <div class="mt-3 pt-3 border-top">
                            <p class="mb-1"><strong>Mã sản phẩm:</strong> <span th:text="${product.sku}"></span></p>
                            <p class="mb-1"><strong>Danh mục:</strong> <span th:text="${product.categoryName}"></span></p>
                        </div>
                    </div>
                </details>

                <details class="detail-bar">
                    <summary class="d-flex justify-content-between align-items-center py-3 border-bottom cursor-pointer">
                        <span class="text-uppercase fw-bold small">HƯỚNG DẪN BẢO QUẢN</span>
                        <i class="fas fa-plus small"></i>
                    </summary>
                    <div class="py-3 text-secondary small">
                        <p>- Giặt tay hoặc giặt máy ở chế độ nhẹ.</p>
                        <p>- Không sử dụng chất tẩy rửa mạnh.</p>
                        <p>- Phơi ở nơi thoáng mát, tránh ánh nắng trực tiếp.</p>
                    </div>
                </details>
            </div>

        </div>
    </div>
</div>

<div class="container my-5 review-section" id="reviewSection">
    <div class="row">
        <div class="col-lg-4 pe-lg-5 mb-4 mb-lg-0">
            <h2 class="text-uppercase fw-bold mb-4" style="font-family: 'Inter', sans-serif;">ĐÁNH GIÁ<br>SẢN PHẨM</h2>

            <div class="d-flex align-items-center gap-3 mb-4">
                <span class="display-4 fw-bold" th:text="${ratingSummary.averageRating}">5</span>
                <div>
                    <div class="text-warning fs-5">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <div class="text-muted small mt-1">Dựa trên <span th:text="${ratingSummary.totalReviews}">0</span> đánh giá</div>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-bold mb-3">Phù hợp với cơ thể</h6>
                <div class="fit-progress mb-2">
                    <div class="row align-items-center g-0 text-muted small">
                        <div class="col-3">Chật</div>
                        <div class="col-8 px-2"><div class="progress" style="height: 6px;"><div class="progress-bar bg-dark" style="width: 0%"></div></div></div>
                        <div class="col-1 text-end">0%</div>
                    </div>
                </div>
                <div class="fit-progress mb-2">
                    <div class="row align-items-center g-0 text-muted small">
                        <div class="col-3">Đúng kích thước</div>
                        <div class="col-8 px-2"><div class="progress" style="height: 6px;"><div class="progress-bar bg-dark" style="width: 100%"></div></div></div>
                        <div class="col-1 text-end">100%</div>
                    </div>
                </div>
                <div class="fit-progress mb-2">
                    <div class="row align-items-center g-0 text-muted small">
                        <div class="col-3">Rộng</div>
                        <div class="col-8 px-2"><div class="progress" style="height: 6px;"><div class="progress-bar bg-dark" style="width: 0%"></div></div></div>
                        <div class="col-1 text-end">0%</div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold small text-muted">Lọc đánh giá</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 rounded-start-pill ps-3"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 rounded-end-pill shadow-none" placeholder="Tìm kiếm đánh giá">
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-bold text-muted small mb-3">Phân loại xếp hạng</h6>
                <div class="d-flex flex-column gap-2">
                    <label class="d-flex align-items-center cursor-pointer">
                        <input type="checkbox" class="form-check-input mt-0 me-2 filter-cb"
                               onchange="toggleFilter(5, this)">

                        <span class="me-2 small fw-bold">5</span>
                        <div class="text-warning small"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                    </label>

                    <label class="d-flex align-items-center cursor-pointer">
                        <input type="checkbox" class="form-check-input mt-0 me-2 filter-cb"
                               onchange="toggleFilter(4, this)">
                        <span class="me-2 small fw-bold">4</span>
                        <div class="small"><span class="text-warning"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span><span class="text-muted"><i class="fas fa-star"></i></span></div>
                    </label>

                    <label class="d-flex align-items-center cursor-pointer">
                        <input type="checkbox" class="form-check-input mt-0 me-2 filter-cb"
                               onchange="toggleFilter(3, this)">
                        <span class="me-2 small fw-bold">3</span>
                        <div class="small"><span class="text-warning"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span><span class="text-muted"><i class="fas fa-star"></i><i class="fas fa-star"></i></span></div>
                    </label>

                    <label class="d-flex align-items-center cursor-pointer mt-2">
                        <input type="checkbox" class="form-check-input mt-0 me-2 filter-cb"
                               onchange="toggleFilter('media', this)">
                        <span class="small">Có Bình luận/Ảnh</span>
                    </label>
                </div>
            </div>

            <div class="text-primary small fw-bold mb-4">
                <i class="fas fa-check-circle me-1"></i> Các review đều đến từ khách hàng đã thực sự mua hàng
            </div>
        </div>

        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <span class="text-muted small">Hiển thị đánh giá <strong>1-<span th:text="${reviews.size()}">10</span></strong></span>
                <div class="dropdown">
                    <button class="btn btn-white border rounded-pill shadow-sm btn-sm px-3 fw-bold" type="button" data-bs-toggle="dropdown">
                        Sắp xếp <i class="fas fa-chevron-down ms-1 text-muted" style="font-size: 10px;"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                        <li><a class="dropdown-item" href="#">Mới nhất</a></li>
                        <li><a class="dropdown-item" href="#">Cũ nhất</a></li>
                    </ul>
                </div>
            </div>

            <div class="review-list">
                <div class="card border-0 shadow-sm mb-3 review-card review-item"
                     th:each="review : ${reviews}"
                     th:data-star="${review.stars}"
                     th:data-has-media="${!#lists.isEmpty(review.images)}">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold" th:text="${review.userName}">iammyivu</span>
                                <span class="text-muted small">• <span th:text="${review.timeAgo}">28/10/2025</span></span>
                            </div>
                            <div class="text-muted fst-italic small">
                                Đã xác thực từ <span class="fw-bold text-dark fst-normal"><i class="fas fa-shopping-bag me-1"></i> Tulip Shop</span>
                            </div>
                        </div>

                        <div class="mb-2 text-dark" style="font-size: 10px;">
                            <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, review.stars)}"></i>
                            <i class="far fa-star text-muted" th:each="i : ${#numbers.sequence(review.stars + 1, 5)}" th:if="${review.stars < 5}"></i>
                        </div>

                        <div class="mb-3 small text-muted">
                            <span th:if="${review.variantInfo}" th:utext="${#strings.replace(review.variantInfo, ',', '</span> &nbsp;|&nbsp; <span>')}"></span>
                        </div>

                        <p class="text-dark mb-3" style="font-size: 14px;" th:text="${review.content}">Nội dung đánh giá...</p>

                        <div class="d-flex gap-2" th:if="${!review.images.isEmpty()}">
                            <img th:each="img : ${review.images}"
                                 th:src="${img}"
                                 class="rounded border"
                                 style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                                 onclick="zoomReviewImage(this)">
                        </div>
                    </div>
                </div>

                <div th:if="${reviews.isEmpty()}" class="text-center py-5 text-muted bg-light rounded">
                    <p>Chưa có đánh giá nào.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reviewImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 text-center position-relative">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                <img src="" id="reviewImageZoom" class="img-fluid rounded shadow-lg" style="max-height: 80vh;">
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
    const productData = /*[[${product}]]*/ {};
</script>

<script th:src="@{/js/product-detail.js}"></script>

</body>
</html>