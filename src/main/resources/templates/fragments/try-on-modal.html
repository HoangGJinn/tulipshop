<div th:fragment="tryOnModal">
    <div class="modal fade" id="tryOnModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-magic me-2 text-warning"></i>Phòng Thử Đồ Ảo (AI)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <div class="col-lg-4 bg-light p-4 border-end">
                            <h6 class="fw-bold mb-3">1. Ảnh của bạn</h6>
                            <div class="position-relative mb-3" style="height: 300px; border: 2px dashed #ccc; border-radius: 10px; overflow: hidden;">
                                <img id="previewModel" src="https://via.placeholder.com/300x400?text=Upload+Photo" class="w-100 h-100 object-fit-cover">
                                <label class="btn btn-light position-absolute bottom-0 end-0 m-2 shadow-sm">
                                    <i class="fas fa-camera text-primary"></i>
                                    <input type="file" id="userModelUpload" hidden accept="image/*">
                                </label>
                            </div>

                            <h6 class="fw-bold mb-2">2. Loại đồ</h6>
                            <select id="clothCategory" class="form-select mb-3">
                                <option value="Upper-body">Áo</option>
                                <option value="Lower-body">Quần/Váy ngắn</option>
                                <option value="Dress">Váy liền</option>
                            </select>

                            <img id="productImageSrc" class="d-none"
                                 th:src="${product != null and product.variants != null and !product.variants.empty and !product.variants[0].images.empty} ? ${product.variants[0].images[0]} : '/images/no-image.png'">

                            <button id="btnTryOn" class="btn btn-primary w-100 py-3 fw-bold" onclick="startTryOn()">
                                <i class="fas fa-wand-magic-sparkles me-2"></i>MẶC THỬ NGAY
                            </button>
                        </div>

                        <div class="col-lg-8 bg-white d-flex justify-content-center align-items-center position-relative" style="min-height: 500px;">
                            <div id="resultArea" class="text-center text-muted">
                                <i class="fas fa-tshirt fa-3x mb-3 opacity-25"></i>
                                <p>Kết quả sẽ hiện ở đây</p>
                            </div>

                            <div id="loadingOverlay" class="position-absolute w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center d-none" style="z-index: 10;">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <h6 class="fw-bold">AI đang xử lý... (30-50s)</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedModelUrl = "";

        function openTryOnModal() {
            var myModal = new bootstrap.Modal(document.getElementById('tryOnModal'));
            myModal.show();
        }

        document.getElementById('userModelUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if(!file) return;
            document.getElementById('previewModel').src = URL.createObjectURL(file);

            const formData = new FormData();
            formData.append("file", file);

            try {
                // Upload ảnh người dùng lên Cloudinary
                const res = await fetch('/api/upload/image', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.url) selectedModelUrl = data.url;
            } catch(err) {
                console.error(err);
                alert("Lỗi upload ảnh: " + err.message);
            }
        });

        async function startTryOn() {
            if(!selectedModelUrl) {
                alert("Vui lòng tải ảnh của bạn lên trước!");
                return;
            }

            const productImg = document.getElementById('productImageSrc').src;
            if(productImg.includes("no-image")) {
                alert("Sản phẩm này chưa có ảnh để thử!");
                return;
            }

            const category = document.getElementById('clothCategory').value;

            document.getElementById('btnTryOn').disabled = true;
            document.getElementById('loadingOverlay').classList.remove('d-none');

            try {
                const res = await fetch('/api/try-on/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        personUrl: selectedModelUrl,
                        clothUrl: productImg,
                        category: category
                    })
                });
                const data = await res.json();

                if(data.success) {
                    document.getElementById('resultArea').innerHTML = `
        <div class="d-flex justify-content-center align-items-center bg-dark rounded position-relative" style="width: 100%; height: 500px; overflow: hidden;">

            <img src="${data.imageUrl}"
                 style="max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5);">

            <a href="${data.imageUrl}" download="try-on-result.webp" class="btn btn-light rounded-circle position-absolute bottom-0 end-0 m-3 shadow-lg" title="Tải ảnh về">
                <i class="fas fa-download text-dark"></i>
            </a>
        </div>
    `;
                } else {
                    alert("Lỗi AI: " + data.message);
                }
            } catch(err) {
                alert("Lỗi kết nối Server: " + err.message);
            } finally {
                document.getElementById('btnTryOn').disabled = false;
                document.getElementById('loadingOverlay').classList.add('d-none');
            }
        }
    </script>
</div>