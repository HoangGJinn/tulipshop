<!-- Chat Widget Fragment -->
<div th:fragment="chatWidget" xmlns:th="http://www.thymeleaf.org">
    <div class="chat-container">
        <div class="chat-bubble" id="chatBubble">
            <i class="fas fa-comments"></i>
            <span class="notification-badge" id="notificationBadge" style="display: none;">1</span>
        </div>
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div>
                    <h5>Tulip Assistant</h5>
                    <div class="status">
                        <i class="fas fa-circle" style="font-size: 8px;"></i> Online
                    </div>
                </div>
                <button class="close-chat" id="closeChat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-bubble">
                        Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa Tulip Shop. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m s·∫£n ph·∫©m ph√π h·ª£p v√† t∆∞ v·∫•n ch√≠nh s√°ch. B·∫°n ƒëang t√¨m ki·∫øm g√¨ h√¥m nay? üå∑
                        <div class="message-time">V·ª´a xong</div>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="500">
                    <button id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .chat-bubble {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .chat-bubble i {
            color: white;
            font-size: 24px;
        }
        
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .chat-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e1e8ed;
            /* NgƒÉn touch events leak ra ngo√†i */
            touch-action: none;
        }
        
        .chat-window.open {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .chat-header .status {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .close-chat:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: #f8f9fa;
            /* NgƒÉn scroll leak ra ngo√†i - ch·ªâ scroll trong khung chat */
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.customer {
            justify-content: flex-end;
        }
        
        .message.bot {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.customer .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.bot .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e1e8ed;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .message.customer .message-time {
            text-align: right;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-bottom: 15px;
            width: fit-content;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        .product-recommendations {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .product-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 8px;
            width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .product-card .product-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-card .product-price {
            font-size: 11px;
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .policy-advice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
        }
        
        .policy-advice i {
            margin-right: 5px;
            color: #f39c12;
        }
        
        .chat-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e1e8ed;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            border: 1px solid #e1e8ed;
            border-radius: 25px;
            padding: 10px 15px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .chat-input input:focus {
            border-color: #667eea;
        }
        
        .chat-input button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chat-input button:hover {
            transform: scale(1.1);
        }
        
        .chat-input button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .chat-window.open {
            display: flex;
        }
        
        @media (max-width: 480px) {
            .chat-window {
                width: 100%;
                right: -10px;
                left: -10px;
                height: 450px;
            }
        }
    </style>
    
    <script th:inline="javascript">
        class TulipChat {
            constructor() {
                this.sessionId = null;
                this.sessionToken = null;
                this.isOpen = false;
                this.isTyping = false;
                this.unreadCount = 0;
                this.sessionInitialized = false; // Track if session has been initialized
                
                this.initElements();
                this.initEventListeners();
                // KH√îNG t·ª± ƒë·ªông t·∫°o session khi load trang
                // Ch·ªâ t·∫°o khi user click v√†o chat bubble
            }
            
            initElements() {
                this.chatBubble = document.getElementById('chatBubble');
                this.chatWindow = document.getElementById('chatWindow');
                this.closeChat = document.getElementById('closeChat');
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.notificationBadge = document.getElementById('notificationBadge');
            }
            
            initEventListeners() {
                console.log('Initializing event listeners...');
                console.log('Chat bubble:', this.chatBubble);
                console.log('Chat window:', this.chatWindow);
                
                if (!this.chatBubble || !this.chatWindow) {
                    console.error('Chat elements not found!');
                    return;
                }
                
                this.chatBubble.addEventListener('click', () => {
                    console.log('Chat bubble clicked!');
                    this.toggleChat();
                });
                
                this.closeChat.addEventListener('click', () => this.closeChatWindow());
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.chatMessages.addEventListener('DOMNodeInserted', () => {
                    this.scrollToBottom();
                });
                
                // NgƒÉn scroll page ch·ªâ khi wheel event x·∫£y ra trong chat window
                if (this.chatWindow) {
                    this.chatWindow.addEventListener('wheel', (e) => {
                        const scrollTop = this.chatMessages.scrollTop;
                        const scrollHeight = this.chatMessages.scrollHeight;
                        const clientHeight = this.chatMessages.clientHeight;
                        
                        // N·∫øu ƒëang scroll l√™n v√† ƒë√£ ·ªü ƒë·∫ßu
                        if (e.deltaY < 0 && scrollTop === 0) {
                            e.preventDefault();
                        }
                        // N·∫øu ƒëang scroll xu·ªëng v√† ƒë√£ ·ªü cu·ªëi
                        else if (e.deltaY > 0 && scrollTop + clientHeight >= scrollHeight) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                }
                
                console.log('Event listeners initialized!');
            }
            
            async initSession() {
                try {
                    console.log('Initializing chat session...');
                    const response = await fetch('/api/chat/session', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    console.log('Chat session response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Chat session data:', data);
                        this.sessionId = data.sessionId;
                        this.sessionToken = data.sessionToken;
                        
                        if (data.messages && data.messages.length > 0) {
                            this.loadMessages(data.messages);
                        }
                    } else if (response.status === 401) {
                        // User not authenticated
                        console.log('User not authenticated for chat');
                        this.addMessage('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng tr√≤ chuy·ªán. <a href="/auth/login" style="color: #667eea; text-decoration: underline;">ƒêƒÉng nh·∫≠p ngay</a>', 'bot');
                        this.disableChatInput();
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to initialize chat session:', response.status, errorText);
                        // Show fallback message
                        this.addMessage('Xin l·ªói, kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn tr·ª£ l√Ω ·∫£o. Vui l√≤ng t·∫£i l·∫°i trang.', 'bot');
                        this.disableChatInput();
                    }
                } catch (error) {
                    console.error('Failed to initialize chat session:', error);
                    // Show fallback message
                    this.addMessage('Xin l·ªói, c√≥ l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.', 'bot');
                    this.disableChatInput();
                }
            }
            
            async toggleChat() {
                console.log('Toggle chat called, current isOpen:', this.isOpen);
                
                // N·∫øu ƒëang ƒë√≥ng v√† ch∆∞a kh·ªüi t·∫°o session, t·∫°o session ngay
                if (!this.isOpen && !this.sessionInitialized) {
                    console.log('üîÑ First time opening AI chat, initializing session...');
                    await this.initSession();
                    this.sessionInitialized = true;
                }
                
                this.isOpen = !this.isOpen;
                console.log('New isOpen:', this.isOpen);
                
                if (this.isOpen) {
                    this.chatWindow.classList.add('open');
                    this.chatBubble.style.display = 'none';
                    this.messageInput.focus();
                    this.markMessagesAsRead();
                    console.log('Chat window opened');
                } else {
                    this.chatWindow.classList.remove('open');
                    this.chatBubble.style.display = 'flex';
                    console.log('Chat window closed');
                }
            }
            
            closeChatWindow() {
                this.isOpen = false;
                this.chatWindow.classList.remove('open');
                this.chatBubble.style.display = 'flex';
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isTyping) return;
                
                // N·∫øu ch∆∞a c√≥ session, t·∫°o m·ªõi tr∆∞·ªõc khi g·ª≠i
                if (!this.sessionId || !this.sessionToken) {
                    console.log('üîÑ No AI chat session found, initializing before sending...');
                    await this.initSession();
                    this.sessionInitialized = true;
                    
                    // Ki·ªÉm tra l·∫°i sau khi init
                    if (!this.sessionId || !this.sessionToken) {
                        this.addMessage('Kh√¥ng th·ªÉ kh·ªüi t·∫°o phi√™n tr√≤ chuy·ªán. Vui l√≤ng th·ª≠ l·∫°i.', 'bot');
                        return;
                    }
                }
                
                console.log('Sending message:', message);
                console.log('Session ID:', this.sessionId);
                
                this.addMessage(message, 'customer');
                this.messageInput.value = '';
                
                this.showTypingIndicator();
                this.isTyping = true;
                
                try {
                    const response = await fetch(`/api/chat/session/${this.sessionId}/message`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ content: message })
                    });
                    
                    console.log('Message response status:', response.status);
                    
                    if (response.ok) {
                        const botMessage = await response.json();
                        console.log('Bot message response:', botMessage);
                        this.hideTypingIndicator();
                        this.addBotMessage(botMessage);
                        this.isTyping = false;
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to send message:', response.status, errorText);
                        this.hideTypingIndicator();
                        this.addMessage('Xin l·ªói, c√≥ l·ªói x·∫£y ra khi g·ª≠i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.', 'bot');
                        this.isTyping = false;
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.hideTypingIndicator();
                    this.addMessage('Xin l·ªói, c√≥ l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.', 'bot');
                    this.isTyping = false;
                }
            }
            
            addMessage(content, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                bubbleDiv.innerHTML = `
                    ${content}
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                messageDiv.appendChild(bubbleDiv);
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            addBotMessage(botMessage) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                
                let content = botMessage.content || '';
                
                if (botMessage.recommendedProducts && botMessage.recommendedProducts.length > 0) {
                    content += '<div class="product-recommendations">';
                    botMessage.recommendedProducts.forEach(product => {
                        content += `
                            <div class="product-card" onclick="window.location.href='/product/${product.id}'">
                                <img src="${product.thumbnail || '/images/product-placeholder.jpg'}" alt="${product.name}">
                                <div class="product-name">${product.name}</div>
                                <div class="product-price">${this.formatPrice(product.basePrice || product.discountPrice)}</div>
                            </div>
                        `;
                    });
                    content += '</div>';
                }
                
                if (botMessage.policyAdvice) {
                    content += `
                        <div class="policy-advice">
                            <i class="fas fa-info-circle"></i>
                            ${botMessage.policyAdvice}
                        </div>
                    `;
                }
                
                bubbleDiv.innerHTML = `
                    ${content}
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                messageDiv.appendChild(bubbleDiv);
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            loadMessages(messages) {
                messages.forEach(message => {
                    if (message.senderType === 'CUSTOMER') {
                        this.addMessage(message.content, 'customer');
                    } else {
                        this.addBotMessage(message);
                    }
                });
            }
            
            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.scrollToBottom();
            }
            
            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
            
            getCurrentTime() {
                const now = new Date();
                return now.toLocaleTimeString('vi-VN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            
            formatPrice(price) {
                if (!price) return 'Li√™n h·ªá';
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(price).replace('‚Ç´', 'ƒë');
            }
            
            async markMessagesAsRead() {
                if (this.sessionId && this.unreadCount > 0) {
                    try {
                        await fetch(`/api/chat/session/${this.sessionId}/read`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        this.unreadCount = 0;
                        this.updateNotificationBadge();
                    } catch (error) {
                        console.error('Error marking messages as read:', error);
                    }
                }
            }
            
            updateNotificationBadge() {
                if (this.unreadCount > 0 && !this.isOpen) {
                    this.notificationBadge.textContent = this.unreadCount;
                    this.notificationBadge.style.display = 'flex';
                } else {
                    this.notificationBadge.style.display = 'none';
                }
            }
            
            disableChatInput() {
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
                this.messageInput.placeholder = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ tr√≤ chuy·ªán';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.tulipChat = new TulipChat();
        });
    </script>
</div>
