<div th:fragment="scripts">
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        function init3DViewers() {
            const canvasContainers = document.querySelectorAll('.canvas-container');

            if (canvasContainers.length === 0) return;

            // Array to store all viewer instances for cleanup
            const viewerInstances = [];

            canvasContainers.forEach((container, index) => {
                // Extract configuration from data attributes
                const modelSrc = container.dataset.modelSrc;
                const modelScale = parseFloat(container.dataset.modelScale) || 2.0; // Default scale
                const modelY = parseFloat(container.dataset.modelY) || 0; // Default Y offset

                if (!modelSrc) {
                    console.warn(`No model path specified for container ${index + 1}`);
                    return;
                }

                // Create isolated Three.js scene for this container
                const scene = new THREE.Scene();
                scene.background = null; // Transparent background

                // Camera setup
                const camera = new THREE.PerspectiveCamera(
                    50, // FOV
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );
                camera.position.set(0, 0, 5);

                // Renderer setup
                const renderer = new THREE.WebGLRenderer({
                    alpha: true, // Transparent background
                    antialias: true
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(renderer.domElement);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 1);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);

                // Controls
                const controls = new OrbitControls(camera, renderer.domElement);
                controls.enableRotate = true;
                controls.enableZoom = false;
                controls.enablePan = false;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 1.0;
                controls.minDistance = 3;
                controls.maxDistance = 10;

                // Load model with custom configuration
                const loader = new GLTFLoader();
                loader.load(
                    modelSrc,
                    (gltf) => {
                        const model = gltf.scene;
                        scene.add(model);

                        // Center and scale model using custom configuration
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());

                        // Use custom scale from data attribute
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const calculatedScale = modelScale / maxDim;
                        model.scale.multiplyScalar(calculatedScale);

                        // Position model with custom Y offset
                        model.position.x = -center.x * calculatedScale;
                        model.position.y = -center.y * calculatedScale + modelY; // Apply custom Y offset
                        model.position.z = -center.z * calculatedScale;

                        // Animation loop
                        let animationId;
                        function animate() {
                            animationId = requestAnimationFrame(animate);
                            controls.update();
                            renderer.render(scene, camera);
                        }
                        animate();

                        // Store animation ID for cleanup
                        container._animationId = animationId;
                    },
                    (progress) => {
                        // Loading progress
                        if (progress.lengthComputable) {
                            // console.log(`Container ${index + 1} - Loading model:`, (progress.loaded / progress.total * 100).toFixed(0) + '%');
                        }
                    },
                    (error) => {
                        console.error(`Error loading 3D model for container ${index + 1}:`, error);
                        // Fallback: show error message
                        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-family: monospace; text-align: center; padding: 20px;">3D Model Loading Error<br><small>Please check the model path</small></div>';
                    }
                );

                // Handle resize for this specific container
                function handleResize() {
                    const width = container.clientWidth;
                    const height = container.clientHeight;

                    if (width > 0 && height > 0) {
                        camera.aspect = width / height;
                        camera.updateProjectionMatrix();
                        renderer.setSize(width, height);
                    }
                }

                // Use ResizeObserver for better performance
                const resizeObserver = new ResizeObserver(handleResize);
                resizeObserver.observe(container);

                // Store references for cleanup and management
                const viewerInstance = {
                    container: container,
                    scene: scene,
                    renderer: renderer,
                    camera: camera,
                    controls: controls,
                    resizeObserver: resizeObserver,
                    dispose: function () {
                        // Cancel animation
                        if (this.container._animationId) {
                            cancelAnimationFrame(this.container._animationId);
                        }
                        // Dispose of Three.js resources
                        this.scene.traverse((object) => {
                            if (object.geometry) object.geometry.dispose();
                            if (object.material) {
                                if (Array.isArray(object.material)) {
                                    object.material.forEach(material => material.dispose());
                                } else {
                                    object.material.dispose();
                                }
                            }
                        });
                        this.renderer.dispose();
                        this.controls.dispose();
                        this.resizeObserver.disconnect();
                        // Clear container
                        if (this.container.contains(this.renderer.domElement)) {
                            this.container.removeChild(this.renderer.domElement);
                        }
                    }
                };

                container._threeScene = scene;
                container._threeRenderer = renderer;
                container._threeCamera = camera;
                container._threeControls = controls;
                container._viewerInstance = viewerInstance;

                viewerInstances.push(viewerInstance);
            });

            // Store all instances globally for potential cleanup
            window._threeViewerInstances = viewerInstances;

            console.log(`Initialized ${viewerInstances.length} 3D viewer(s)`);
        }

        // Initialize 3D viewers when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init3DViewers);
        } else {
            // Small delay to ensure other scripts have initialized
            setTimeout(init3DViewers, 100);
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const slider = document.getElementById('sale-slider');
            const prevBtn = document.getElementById('btn-sale-prev');
            const nextBtn = document.getElementById('btn-sale-next');

            if (slider && prevBtn && nextBtn) {
                nextBtn.addEventListener('click', () => {
                    // Cuộn sang phải 1 khoảng bằng chiều rộng thẻ + gap
                    const cardWidth = slider.querySelector('div').offsetWidth;
                    slider.scrollBy({ left: cardWidth + 24, behavior: 'smooth' });
                });

                prevBtn.addEventListener('click', () => {
                    const cardWidth = slider.querySelector('div').offsetWidth;
                    slider.scrollBy({ left: -(cardWidth + 24), behavior: 'smooth' });
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            // --- Xử lý cho Slider Danh mục nổi bật ---
            const catSlider = document.getElementById('category-slider');
            const catPrevBtn = document.getElementById('btn-cat-prev');
            const catNextBtn = document.getElementById('btn-cat-next');

            if (catSlider && catPrevBtn && catNextBtn) {
                catNextBtn.addEventListener('click', () => {
                    // Lấy chiều rộng thẻ đầu tiên + margin (để cuộn chính xác 1 thẻ)
                    const firstCard = catSlider.querySelector('div');
                    const scrollAmount = firstCard ? firstCard.offsetWidth + 16 : 300; // 16 là margin-right
                    catSlider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                });

                catPrevBtn.addEventListener('click', () => {
                    const firstCard = catSlider.querySelector('div');
                    const scrollAmount = firstCard ? firstCard.offsetWidth + 16 : 300;
                    catSlider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                });
            }
        });

        // Hàm load dữ liệu theo tab
        function loadTab(type, btnElement) {
            const grid = document.getElementById('tab-product-grid');

            // 1. Cập nhật giao diện nút (Active State)
            // Reset tất cả nút về màu xám
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn tw-text-gray-500 hover:tw-text-black tw-pb-4 -tw-mb-4 tw-border-b-2 tw-border-transparent hover:tw-border-gray-300 tw-transition-colors';
            });
            // Set nút đang bấm thành màu đỏ (Active)
            if (btnElement) {
                btnElement.className = 'tab-btn tw-font-bold tw-text-primary tw-border-b-2 tw-border-primary tw-pb-4 -tw-mb-4 tw-transition-colors';
            }

            // 2. Hiển thị loading
            grid.innerHTML = '<div class="tw-col-span-full tw-flex tw-justify-center tw-items-center tw-h-40"><div class="tw-animate-spin tw-rounded-full tw-h-8 tw-w-8 tw-border-b-2 tw-border-primary"></div></div>';

            // 3. Chọn API tương ứng
            let apiUrl = '/v1/api/store/new-arrivals';
            if (type === 'sale') apiUrl = '/v1/api/store/sale-18';
            if (type === 'trending') apiUrl = '/v1/api/store/trending';

            // 4. Gọi API
            fetch(apiUrl)
                .then(res => res.json())
                .then(products => {
                    grid.innerHTML = ''; // Xóa loading

                    if (!products || products.length === 0) {
                        grid.innerHTML = '<div class="tw-col-span-full tw-text-center tw-text-gray-400">Không có sản phẩm nào.</div>';
                        return;
                    }

                    // 5. Render HTML
                    products.forEach(p => {
                        const price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.price);
                        let oldPriceHtml = '';
                        let badgeHtml = '';

                        if (p.originalPrice && p.originalPrice > p.price) {
                            const oldPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.originalPrice);
                            oldPriceHtml = `<span class="tw-text-gray-400 tw-text-xs tw-line-through">${oldPrice}</span>`;
                            // Tính % giảm
                            const percent = Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100);
                            if (percent > 0) {
                                badgeHtml = `<span class="tw-absolute tw-top-2 tw-left-2 tw-bg-yellow-600 tw-text-white tw-text-[10px] tw-font-bold tw-px-2 tw-py-1">-${percent}%</span>`;
                            }
                        } else if (type === 'new') {
                            // Badge NEW cho tab Hàng mới
                            badgeHtml = `<span class="tw-absolute tw-top-2 tw-left-2 tw-bg-blue-600 tw-text-white tw-text-[10px] tw-font-bold tw-px-2 tw-py-1">NEW</span>`;
                        }

                        const itemHtml = `
                                    <div class="tw-group">
                                        <a href="${p.url}" class="tw-block">
                                            <div class="tw-relative tw-overflow-hidden tw-mb-3">
                                                <img src="${p.thumbnail}" alt="${p.name}"
                                                     class="tw-w-full tw-aspect-[3/4] tw-object-cover tw-object-top tw-transition-transform tw-duration-700 group-hover:tw-scale-105">
                                                ${badgeHtml}
                                            </div>
                                            <h3 class="tw-text-xs tw-text-gray-500 tw-mb-1 tw-truncate tw-uppercase">${p.name}</h3>
                                            <div class="tw-flex tw-items-baseline tw-gap-2">
                                                <span class="tw-text-black tw-font-bold tw-text-sm">${price}</span>
                                                ${oldPriceHtml}
                                            </div>
                                        </a>
                                    </div>
                                `;
                        grid.insertAdjacentHTML('beforeend', itemHtml);
                    });
                })
                .catch(err => {
                    console.error(err);
                    grid.innerHTML = '<div class="tw-col-span-full tw-text-center tw-text-red-500">Lỗi tải dữ liệu.</div>';
                });
        }

        // Tự động load tab đầu tiên (Hàng mới về) khi trang tải xong
        document.addEventListener('DOMContentLoaded', () => {
            // Tìm nút đầu tiên để active style
            const firstBtn = document.querySelector('.tab-btn');
            loadTab('new', firstBtn);
        });

        function toggleHotspot(cardId) {
            // 1. Đóng tất cả các thẻ đang mở trước
            document.querySelectorAll('.hotspot-card').forEach(card => {
                if (card.id !== cardId) {
                    card.classList.add('tw-hidden');
                }
            });

            // 2. Bật/Tắt thẻ được chọn
            const card = document.getElementById(cardId);
            if (card) {
                // Nếu đang ẩn thì hiện, đang hiện thì ẩn
                if (card.classList.contains('tw-hidden')) {
                    card.classList.remove('tw-hidden');
                } else {
                    card.classList.add('tw-hidden');
                }
            }
        }

        function closeHotspot(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.add('tw-hidden');
            }
        }

        // Click ra ngoài thì đóng hết popup
        document.addEventListener('click', function (event) {
            const isClickInsideHotspot = event.target.closest('.hotspot-point');
            const isClickInsideCard = event.target.closest('.hotspot-card');

            if (!isClickInsideHotspot && !isClickInsideCard) {
                document.querySelectorAll('.hotspot-card').forEach(card => {
                    card.classList.add('tw-hidden');
                });
            }
        });

        function loadOccasion(tag, btnElement) {
            const grid = document.getElementById('occasion-grid');

            // 1. Update Active State cho nút
            document.querySelectorAll('.occasion-btn').forEach(btn => {
                btn.className = 'occasion-btn tw-text-gray-500 hover:tw-text-black tw-transition-colors tw-border-b-2 tw-border-transparent hover:tw-border-gray-300';
            });
            if (btnElement) {
                btnElement.className = 'occasion-btn tw-font-bold tw-text-black tw-border-b-2 tw-border-black tw-pb-1 tw-transition-colors';
            }

            // 2. Hiển thị Loading
            grid.innerHTML = '<div class="tw-col-span-full tw-flex tw-justify-center tw-py-10"><div class="tw-animate-spin tw-rounded-full tw-h-8 tw-w-8 tw-border-b-2 tw-border-gray-900"></div></div>';

            // 3. Gọi API
            fetch(`/v1/api/store/occasion?tag=${tag}`)
                .then(res => res.json())
                .then(products => {
                    grid.innerHTML = '';

                    if (!products || products.length === 0) {
                        grid.innerHTML = '<div class="tw-col-span-full tw-text-center tw-text-gray-400">Chưa có sản phẩm cho mục này.</div>';
                        return;
                    }

                    // 4. Render HTML
                    products.forEach(p => {
                        const price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.price);

                        const html = `
                                    <div class="tw-group">
                                        <div class="tw-relative tw-overflow-hidden tw-mb-3">
                                            <a href="${p.url}">
                                                <img src="${p.thumbnail}" alt="${p.name}"
                                                     class="tw-w-full tw-aspect-[3/4] tw-object-cover tw-object-top tw-transition-transform tw-duration-500 group-hover:tw-scale-105">
                                            </a>
                                        </div>
                                        <h3 class="tw-text-xs tw-text-gray-500 tw-mb-1 tw-truncate tw-uppercase">${p.name}</h3>
                                        <div class="tw-flex tw-items-baseline tw-gap-2">
                                            <span class="tw-text-black tw-font-bold tw-text-sm">${price}</span>
                                        </div>
                                    </div>
                                `;
                        grid.insertAdjacentHTML('beforeend', html);
                    });
                })
                .catch(err => {
                    console.error(err);
                    grid.innerHTML = '<div class="tw-col-span-full tw-text-center tw-text-red-500">Lỗi kết nối server.</div>';
                });
        }

        // Tự động load tab đầu tiên khi vào trang
        document.addEventListener('DOMContentLoaded', () => {
            const firstBtn = document.querySelector('.occasion-btn');
            loadOccasion('di-lam', firstBtn);
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Cấu hình thời gian đếm ngược (tính bằng giây)
            // 24 giờ = 24 * 60 * 60 = 86400 giây
            const CYCLE_SECONDS = 24 * 60 * 60;

            // Key để lưu trữ thời gian bắt đầu vào LocalStorage (để khi F5 không bị reset về 24h từ đầu)
            // Nếu bạn muốn mỗi lần F5 đều reset về 24h thì xóa phần localStorage đi.
            const STORAGE_KEY = 'ede_sale_countdown_start';

            function getRemainingTime() {
                let startTime = localStorage.getItem(STORAGE_KEY);
                const now = Math.floor(Date.now() / 1000); // Thời gian hiện tại (giây)

                if (!startTime) {
                    // Nếu chưa có (người dùng mới vào), set thời gian bắt đầu là NOW
                    startTime = now;
                    localStorage.setItem(STORAGE_KEY, startTime);
                }

                // Tính thời gian đã trôi qua
                const elapsed = now - parseInt(startTime);

                // Tính thời gian còn lại trong chu kỳ
                let remaining = CYCLE_SECONDS - (elapsed % CYCLE_SECONDS);

                return remaining;
            }

            const elH = document.getElementById('countdown-h');
            const elM = document.getElementById('countdown-m');
            const elS = document.getElementById('countdown-s');

            function updateTimer() {
                let time = getRemainingTime();

                // Chuyển đổi giây thành H:M:S
                let h = Math.floor(time / 3600);
                let m = Math.floor((time % 3600) / 60);
                let s = Math.floor(time % 60);

                // Thêm số 0 đằng trước nếu nhỏ hơn 10
                if (elH) elH.innerText = h < 10 ? '0' + h : h;
                if (elM) elM.innerText = m < 10 ? '0' + m : m;
                if (elS) elS.innerText = s < 10 ? '0' + s : s;
            }

            // Chạy ngay lập tức
            updateTimer();
            // Cập nhật mỗi giây
            setInterval(updateTimer, 1000);
        });
    </script>
</div>